# MuSheet åç«¯æ¶æ„è®¾è®¡æ–‡æ¡£

> **å›¢é˜Ÿå†…éƒ¨ç®¡ç†æ¨¡å¼** - ä¸“ä¸ºä¹å›¢/ä¹é˜Ÿç­‰å›¢é˜Ÿç§æœ‰åŒ–éƒ¨ç½²è®¾è®¡

## ç›®å½•

1. [è®¾è®¡å†³ç­–æ€»ç»“](#1-è®¾è®¡å†³ç­–æ€»ç»“)
2. [æŠ€æœ¯æ ˆé€‰å‹](#2-æŠ€æœ¯æ ˆé€‰å‹)
3. [Serverpod æ¶æ„è®¾è®¡](#3-serverpod-æ¶æ„è®¾è®¡)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [æ ¸å¿ƒä¸šåŠ¡é€»è¾‘](#5-æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)
6. [åŒæ­¥æœºåˆ¶è®¾è®¡](#6-åŒæ­¥æœºåˆ¶è®¾è®¡)
7. [Flutter å®¢æˆ·ç«¯å®ç°](#7-flutter-å®¢æˆ·ç«¯å®ç°)
8. [Web ç®¡ç†é¢æ¿](#8-web-ç®¡ç†é¢æ¿)
9. [å¼€å‘è·¯çº¿å›¾](#9-å¼€å‘è·¯çº¿å›¾)

---

## 1. è®¾è®¡å†³ç­–æ€»ç»“

### 1.1 æ ¸å¿ƒç†å¿µ

**å›¢é˜Ÿå†…éƒ¨ç®¡ç†æ¨¡å¼**ï¼šä¸“ä¸ºä¹å›¢ã€ä¹é˜Ÿã€æ•™ä¼šæ•¬æ‹œå›¢ç­‰éŸ³ä¹å›¢é˜Ÿè®¾è®¡ï¼Œç”±å›¢é˜Ÿç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æˆå‘˜è´¦å·ï¼Œæˆå‘˜é—´å¯åä½œå…±äº«ä¹è°±èµ„æºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å›¢é˜Ÿå†…éƒ¨ç®¡ç†æ¨¡å¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   ç®¡ç†å‘˜ (å›¢é•¿/æŒ‡æŒ¥/è´Ÿè´£äºº)                                  â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ åˆ›å»ºæˆå‘˜è´¦å· (åˆ†é…ç”¨æˆ·å+åˆå§‹å¯†ç )                   â”‚
â”‚     â”œâ”€â”€ ç®¡ç†æˆå‘˜æƒé™ (æ™®é€šæˆå‘˜/ç®¡ç†å‘˜)                       â”‚
â”‚     â”œâ”€â”€ æŸ¥çœ‹å›¢é˜Ÿä½¿ç”¨ç»Ÿè®¡                                     â”‚
â”‚     â””â”€â”€ ç®¡ç†å…±äº«èµ„æº                                         â”‚
â”‚                                                             â”‚
â”‚   æ™®é€šæˆå‘˜ (ä¹æ‰‹/æ­Œæ‰‹)                                       â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ ç®¡ç†ä¸ªäººä¹è°±åº“                                       â”‚
â”‚     â”œâ”€â”€ å‘å›¢é˜Ÿå…±äº«ä¹è°±/æ¼”å‡ºå•                                â”‚
â”‚     â”œâ”€â”€ è®¿é—®å›¢é˜Ÿå…±äº«èµ„æº                                     â”‚
â”‚     â””â”€â”€ ä»…èƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å†³ç­–æ±‡æ€»

| å†³ç­–é¡¹ | é€‰æ‹© | è¯´æ˜ |
|--------|------|------|
| **éƒ¨ç½²æ¨¡å¼** | ç§æœ‰åŒ–éƒ¨ç½² (Docker) | å›¢é˜Ÿè‡ªè¡Œéƒ¨ç½²åˆ°å†…ç½‘/ç§æœ‰æœåŠ¡å™¨ |
| **è´¦å·ç®¡ç†** | ç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç† | æ— è‡ªåŠ©æ³¨å†Œï¼Œç®¡ç†å‘˜åˆ›å»ºæ‰€æœ‰è´¦å· |
| **è®¤è¯æ–¹å¼** | ç”¨æˆ·å + å¯†ç  | ç®€å•ç›´æ¥ï¼Œé€‚åˆå›¢é˜Ÿå†…éƒ¨ä½¿ç”¨ |
| **ç”¨æˆ·æƒé™** | ä»…æ”¹å¯†ç  | æ™®é€šæˆå‘˜åªèƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç  |
| **ç¦»çº¿æ¨¡å¼** | å®Œæ•´åŠŸèƒ½ | æœªç™»å½•æ—¶å¯å®Œæ•´ä½¿ç”¨æœ¬åœ°åŠŸèƒ½ |
| **åŒæ­¥ç­–ç•¥** | LWW + CRDT | å…ƒæ•°æ®ç”¨ç®€å•ç­–ç•¥ï¼Œæ‰¹æ³¨ç”¨ CRDT |
| **å›¢é˜Ÿåä½œ** | åä½œç¼–è¾‘ | æˆå‘˜å¯ç›´æ¥ç¼–è¾‘å…±äº«èµ„æº |
| **PDF å­˜å‚¨** | æœ¬åœ°ä¼˜å…ˆ | åå°é™é»˜ä¸Šä¼ ï¼Œæ— å­˜å‚¨é™åˆ¶ |
| **åç«¯æŠ€æœ¯** | Serverpod | Dart å…¨æ ˆï¼Œè‡ªå¸¦ Web ç®¡ç†é¢æ¿ |
| **é¦–ä¸ªç”¨æˆ·** | è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜ | éƒ¨ç½²åç¬¬ä¸€ä¸ªæ³¨å†Œçš„ç”¨æˆ· |

---

## 2. æŠ€æœ¯æ ˆé€‰å‹

### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹© Serverpod

| å¯¹æ¯”é¡¹ | Serverpod | Supabase | è‡ªå»º Node/Go |
|--------|-----------|----------|--------------|
| è¯­è¨€ç»Ÿä¸€ | âœ… å…¨æ ˆ Dart | âŒ | âŒ |
| ç±»å‹å®‰å…¨ | âœ… ç¼–è¯‘æ—¶æ£€æŸ¥ | âŒ | éƒ¨åˆ† |
| ä»£ç ç”Ÿæˆ | âœ… è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯ | âŒ | éœ€æ‰‹åŠ¨ |
| Web UI | âœ… Flutter Web | éœ€å¦å»º | éœ€å¦å»º |
| å®æ—¶é€šä¿¡ | âœ… å†…ç½® WebSocket | âœ… | éœ€é…ç½® |
| ç®¡ç†é¢æ¿ | âœ… Serverpod Insights | âŒ | éœ€å¼€å‘ |
| å­¦ä¹ æ›²çº¿ | ä½ (å·²ä¼š Dart) | ä¸­ | é«˜ |

### 2.2 å®Œæ•´æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Flutter App          â”‚  Flutter Web (ç®¡ç†é¢æ¿)             â”‚
â”‚  - iOS/Android/macOS  â”‚  - æ•°æ®å¯è§†åŒ–                       â”‚
â”‚  - Windows/Linux      â”‚  - ç”¨æˆ·ç®¡ç†                         â”‚
â”‚  - ç¦»çº¿ä¼˜å…ˆ           â”‚  - å­˜å‚¨ç›‘æ§                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Serverpod åç«¯                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Endpoints (API)      â”‚  Modules              â”‚  Services   â”‚
â”‚  - AuthEndpoint       â”‚  - serverpod_auth     â”‚  - SyncSvc  â”‚
â”‚  - ScoreEndpoint      â”‚  - (å†…ç½®è®¤è¯)         â”‚  - FileSvc  â”‚
â”‚  - SetlistEndpoint    â”‚                       â”‚  - TeamSvc  â”‚
â”‚  - TeamEndpoint       â”‚                       â”‚             â”‚
â”‚  - SyncEndpoint       â”‚                       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL           â”‚  æ–‡ä»¶å­˜å‚¨                           â”‚
â”‚  - ç”¨æˆ·æ•°æ®           â”‚  - æœ¬åœ°: æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ             â”‚
â”‚  - ä¹è°±å…ƒæ•°æ®         â”‚  - å¯é€‰: S3/MinIO                  â”‚
â”‚  - åŒæ­¥çŠ¶æ€           â”‚  - PDF + ç¼©ç•¥å›¾                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 é¡¹ç›®ç»“æ„

```
musheet/                         # Flutter App (ç°æœ‰é¡¹ç›®)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ serverpod_service.dart  # æ–°å¢
â”‚   â””â”€â”€ ...
â”œâ”€â”€ docs/                        # æ–‡æ¡£
â””â”€â”€ server/                      # åç«¯ (æ–°å»ºï¼ŒåŒ…å« Server + Admin Web UI)
    â”œâ”€â”€ musheet_server/          # Serverpod åç«¯
    â”‚   â”œâ”€â”€ lib/
    â”‚   â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”‚   â”œâ”€â”€ endpoints/   # API ç«¯ç‚¹
    â”‚   â”‚   â”‚   â”œâ”€â”€ protocol/    # æ•°æ®æ¨¡å‹å®šä¹‰
    â”‚   â”‚   â”‚   â””â”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
    â”‚   â”‚   â””â”€â”€ server.dart
    â”‚   â”œâ”€â”€ migrations/          # æ•°æ®åº“è¿ç§»
    â”‚   â”œâ”€â”€ web/                 # ç®¡ç†é¢æ¿é™æ€æ–‡ä»¶ (Flutter Web ç¼–è¯‘è¾“å‡º)
    â”‚   â””â”€â”€ Dockerfile           # Docker éƒ¨ç½²é…ç½®
    â”‚
    â”œâ”€â”€ musheet_client/          # è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ (ä¾› App å’Œ Admin ä½¿ç”¨)
    â”‚   â””â”€â”€ lib/
    â”‚       â””â”€â”€ src/
    â”‚           â””â”€â”€ protocol/
    â”‚
    â”œâ”€â”€ musheet_admin/           # Flutter Web ç®¡ç†é¢æ¿
    â”‚   â””â”€â”€ lib/
    â”‚       â”œâ”€â”€ screens/
    â”‚       â”‚   â”œâ”€â”€ dashboard/
    â”‚       â”‚   â”œâ”€â”€ users/
    â”‚       â”‚   â””â”€â”€ storage/
    â”‚       â””â”€â”€ ...
    â”‚
    â””â”€â”€ docker-compose.yml       # ä¸€é”®å¯åŠ¨ (PostgreSQL + Server + Admin)
```

**è¯´æ˜ï¼š**
- `server/` ç›®å½•åŒ…å«æ‰€æœ‰åç«¯ç›¸å…³ä»£ç 
- ç®¡ç†é¢æ¿ç¼–è¯‘åéƒ¨ç½²åˆ° `musheet_server/web/`ï¼Œç”± Serverpod ç›´æ¥æä¾›æœåŠ¡
- ä½¿ç”¨ Docker Compose ä¸€é”®éƒ¨ç½²æ•´ä¸ªåç«¯

---

## 3. Serverpod æ¶æ„è®¾è®¡

### 3.1 æ•°æ®æ¨¡å‹å®šä¹‰ (Protocol)

Serverpod ä½¿ç”¨ YAML å®šä¹‰æ¨¡å‹ï¼Œè‡ªåŠ¨ç”Ÿæˆ Dart ç±»ï¼š

```yaml
# musheet_server/lib/src/protocol/score.yaml
class: Score
table: scores
fields:
  userId: int, relation(parent=user)
  title: String
  composer: String?
  bpm: int?
  createdAt: DateTime
  updatedAt: DateTime
  deletedAt: DateTime?
  version: int           # ä¹è§‚é”
  syncStatus: String?    # 'synced', 'pending', 'conflict'
indexes:
  score_user_idx:
    fields: userId
    type: btree
```

```yaml
# musheet_server/lib/src/protocol/instrument_score.yaml
class: InstrumentScore
table: instrument_scores
fields:
  scoreId: int, relation(parent=score)
  instrumentType: String
  customInstrument: String?
  pdfPath: String?           # æœåŠ¡å™¨å­˜å‚¨è·¯å¾„
  thumbnailPath: String?
  fileSize: int?             # ç”¨äºå­˜å‚¨ç»Ÿè®¡
  createdAt: DateTime
  updatedAt: DateTime
```

```yaml
# musheet_server/lib/src/protocol/annotation.yaml
class: Annotation
table: annotations
fields:
  instrumentScoreId: int, relation(parent=instrumentScore)
  pageNumber: int
  annotationType: String     # 'drawing', 'erasing'
  color: int?
  strokeWidth: double?
  points: List<double>       # å½’ä¸€åŒ–åæ ‡
  createdAt: DateTime
  updatedAt: DateTime
  # CRDT ç›¸å…³å­—æ®µ
  vectorClock: String?       # JSON æ ¼å¼çš„å‘é‡æ—¶é’Ÿ
  originDeviceId: String?    # åˆ›å»ºæ­¤æ‰¹æ³¨çš„è®¾å¤‡
```

```yaml
# musheet_server/lib/src/protocol/user_storage.yaml
class: UserStorage
table: user_storage
fields:
  userId: int, relation(parent=user)
  usedBytes: int             # å·²ä½¿ç”¨å­—èŠ‚
  lastCalculatedAt: DateTime
```

### 3.2 API ç«¯ç‚¹è®¾è®¡

```dart
// musheet_server/lib/src/endpoints/score_endpoint.dart

class ScoreEndpoint extends Endpoint {

  /// è·å–ç”¨æˆ·æ‰€æœ‰ä¹è°± (å¢é‡åŒæ­¥)
  Future<List<Score>> getScores(Session session, {
    DateTime? since,  // ä»…è·å–æ­¤æ—¶é—´åæ›´æ–°çš„
  }) async {
    final userId = await session.auth.authenticatedUserId;
    if (userId == null) throw AuthenticationException();

    var query = Score.db.find(
      session,
      where: (t) => t.userId.equals(userId) & t.deletedAt.equals(null),
    );

    if (since != null) {
      query = Score.db.find(
        session,
        where: (t) => t.userId.equals(userId) & t.updatedAt.greaterThan(since),
      );
    }

    return await query;
  }

  /// åˆ›å»ºæˆ–æ›´æ–°ä¹è°± (å¸¦å†²çªæ£€æµ‹)
  Future<ScoreSyncResult> upsertScore(Session session, Score score) async {
    final userId = await session.auth.authenticatedUserId;
    if (userId == null) throw AuthenticationException();

    final existing = await Score.db.findById(session, score.id);

    if (existing != null) {
      // ä¹è§‚é”æ£€æŸ¥
      if (existing.version > score.version) {
        return ScoreSyncResult(
          status: SyncStatus.conflict,
          serverVersion: existing,
        );
      }

      // æ›´æ–°
      score.version = existing.version + 1;
      score.updatedAt = DateTime.now();
      await Score.db.update(session, score);
    } else {
      // åˆ›å»º
      score.userId = userId;
      score.version = 1;
      score.createdAt = DateTime.now();
      score.updatedAt = DateTime.now();
      await Score.db.insert(session, score);
    }

    return ScoreSyncResult(status: SyncStatus.success, serverVersion: score);
  }

  /// è½¯åˆ é™¤ä¹è°±
  Future<bool> deleteScore(Session session, int scoreId) async {
    final userId = await session.auth.authenticatedUserId;
    final score = await Score.db.findById(session, scoreId);

    if (score == null || score.userId != userId) {
      throw PermissionDeniedException();
    }

    score.deletedAt = DateTime.now();
    await Score.db.update(session, score);

    // æ›´æ–°å­˜å‚¨ä½¿ç”¨é‡
    await _recalculateStorage(session, userId);

    return true;
  }
}
```

```dart
// musheet_server/lib/src/endpoints/file_endpoint.dart

class FileEndpoint extends Endpoint {

  /// ä¸Šä¼  PDF æ–‡ä»¶
  Future<FileUploadResult> uploadPdf(
    Session session,
    int instrumentScoreId,
    ByteData fileData,
    String fileName,
  ) async {
    final userId = await session.auth.authenticatedUserId;
    if (userId == null) throw AuthenticationException();

    final fileSize = fileData.lengthInBytes;

    // å­˜å‚¨æ–‡ä»¶
    final path = 'users/$userId/pdfs/${instrumentScoreId}_$fileName';
    await _saveFile(path, fileData);

    // æ›´æ–°è®°å½•
    final instrumentScore = await InstrumentScore.db.findById(session, instrumentScoreId);
    instrumentScore!.pdfPath = path;
    instrumentScore.fileSize = fileSize;
    await InstrumentScore.db.update(session, instrumentScore);

    // æ›´æ–°å­˜å‚¨ç»Ÿè®¡
    await _updateStorageStats(session, userId, fileSize);

    return FileUploadResult(success: true, path: path);
  }

  /// ä¸‹è½½ PDF æ–‡ä»¶
  Future<ByteData> downloadPdf(Session session, int instrumentScoreId) async {
    final userId = await session.auth.authenticatedUserId;

    // éªŒè¯æƒé™ (ä¸ªäººæˆ–å›¢é˜Ÿæˆå‘˜)
    if (!await _hasAccessToInstrumentScore(session, userId, instrumentScoreId)) {
      throw PermissionDeniedException();
    }

    final instrumentScore = await InstrumentScore.db.findById(session, instrumentScoreId);
    return await _readFile(instrumentScore!.pdfPath!);
  }
}
```

### 3.3 è®¤è¯ç«¯ç‚¹

```dart
// musheet_server/lib/src/endpoints/auth_endpoint.dart

class AuthEndpoint extends Endpoint {

  /// ç”¨æˆ·ç™»å½•
  Future<AuthResult> login(
    Session session,
    String username,
    String password,
  ) async {
    final users = await User.db.find(
      session,
      where: (t) => t.username.equals(username),
    );

    if (users.isEmpty) {
      throw InvalidCredentialsException();
    }

    final user = users.first;

    // éªŒè¯å¯†ç 
    if (!_verifyPassword(password, user.passwordHash)) {
      throw InvalidCredentialsException();
    }

    // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«ç¦ç”¨
    if (user.isDisabled) {
      throw AccountDisabledException();
    }

    final token = await _generateAuthToken(session, user);

    return AuthResult(success: true, token: token, user: user);
  }

  /// ç™»å‡º
  Future<void> logout(Session session) async {
    await session.auth.signOut();
  }

  /// ä¿®æ”¹è‡ªå·±çš„å¯†ç 
  Future<bool> changePassword(
    Session session,
    String oldPassword,
    String newPassword,
  ) async {
    final userId = await session.auth.authenticatedUserId;
    if (userId == null) throw AuthenticationException();

    final user = await User.db.findById(session, userId);

    if (!_verifyPassword(oldPassword, user!.passwordHash)) {
      throw InvalidCredentialsException();
    }

    if (!_isStrongPassword(newPassword)) {
      throw WeakPasswordException();
    }

    user.passwordHash = _hashPassword(newPassword);
    user.mustChangePassword = false;  // æ¸…é™¤å¼ºåˆ¶ä¿®æ”¹å¯†ç æ ‡è®°
    await User.db.update(session, user);

    return true;
  }

  /// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  Future<User?> getCurrentUser(Session session) async {
    final userId = await session.auth.authenticatedUserId;
    if (userId == null) return null;
    return await User.db.findById(session, userId);
  }

  // === è¾…åŠ©æ–¹æ³• ===

  bool _isStrongPassword(String password) {
    // è‡³å°‘6ä½
    return password.length >= 6;
  }
}
```

### 3.4 ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†ç«¯ç‚¹

```dart
// musheet_server/lib/src/endpoints/admin_user_endpoint.dart

class AdminUserEndpoint extends Endpoint {

  @override
  bool get requireLogin => true;

  /// éªŒè¯æ˜¯å¦ä¸ºç®¡ç†å‘˜
  Future<void> _requireAdmin(Session session) async {
    final userId = await session.auth.authenticatedUserId;
    final user = await User.db.findById(session, userId);
    if (user == null || !user.isAdmin) {
      throw PermissionDeniedException();
    }
  }

  /// ç®¡ç†å‘˜æ³¨å†Œ (ä»…ç¬¬ä¸€ä¸ªç”¨æˆ·å¯ç”¨)
  Future<AuthResult> registerAdmin(
    Session session,
    String username,
    String password,
    String? displayName,
  ) async {
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ·
    final userCount = await User.db.count(session);
    if (userCount > 0) {
      throw AdminAlreadyExistsException();
    }

    // åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·
    final user = User(
      username: username,
      passwordHash: _hashPassword(password),
      displayName: displayName ?? username,
      isAdmin: true,
      isDisabled: false,
      mustChangePassword: false,
      createdAt: DateTime.now(),
    );
    await User.db.insert(session, user);

    final token = await _generateAuthToken(session, user);
    return AuthResult(success: true, token: token, user: user);
  }

  /// åˆ›å»ºæ–°ç”¨æˆ· (ä»…ç®¡ç†å‘˜)
  Future<User> createUser(
    Session session,
    String username,
    String initialPassword,
    String? displayName,
    bool isAdmin,
  ) async {
    await _requireAdmin(session);

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    final existing = await User.db.find(
      session,
      where: (t) => t.username.equals(username),
    );
    if (existing.isNotEmpty) {
      throw UsernameAlreadyExistsException();
    }

    final user = User(
      username: username,
      passwordHash: _hashPassword(initialPassword),
      displayName: displayName ?? username,
      isAdmin: isAdmin,
      isDisabled: false,
      mustChangePassword: true,  // é¦–æ¬¡ç™»å½•éœ€è¦ä¿®æ”¹å¯†ç 
      createdAt: DateTime.now(),
    );
    await User.db.insert(session, user);

    return user;
  }

  /// è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ (ä»…ç®¡ç†å‘˜)
  Future<List<UserInfo>> getUsers(Session session) async {
    await _requireAdmin(session);

    final users = await User.db.find(session);
    return users.map((u) => UserInfo(
      id: u.id!,
      username: u.username,
      displayName: u.displayName,
      isAdmin: u.isAdmin,
      isDisabled: u.isDisabled,
      createdAt: u.createdAt,
    )).toList();
  }

  /// é‡ç½®ç”¨æˆ·å¯†ç  (ä»…ç®¡ç†å‘˜)
  Future<String> resetUserPassword(Session session, int userId) async {
    await _requireAdmin(session);

    final user = await User.db.findById(session, userId);
    if (user == null) throw UserNotFoundException();

    // ç”Ÿæˆä¸´æ—¶å¯†ç 
    final tempPassword = _generateTempPassword();
    user.passwordHash = _hashPassword(tempPassword);
    user.mustChangePassword = true;
    await User.db.update(session, user);

    return tempPassword;  // è¿”å›ä¸´æ—¶å¯†ç ä¾›ç®¡ç†å‘˜å‘ŠçŸ¥ç”¨æˆ·
  }

  /// ç¦ç”¨/å¯ç”¨ç”¨æˆ· (ä»…ç®¡ç†å‘˜)
  Future<bool> setUserDisabled(Session session, int userId, bool disabled) async {
    await _requireAdmin(session);

    final user = await User.db.findById(session, userId);
    if (user == null) throw UserNotFoundException();

    // ä¸èƒ½ç¦ç”¨è‡ªå·±
    final currentUserId = await session.auth.authenticatedUserId;
    if (userId == currentUserId) {
      throw CannotDisableSelfException();
    }

    user.isDisabled = disabled;
    await User.db.update(session, user);

    return true;
  }

  /// åˆ é™¤ç”¨æˆ· (ä»…ç®¡ç†å‘˜)
  Future<bool> deleteUser(Session session, int userId) async {
    await _requireAdmin(session);

    // ä¸èƒ½åˆ é™¤è‡ªå·±
    final currentUserId = await session.auth.authenticatedUserId;
    if (userId == currentUserId) {
      throw CannotDeleteSelfException();
    }

    final user = await User.db.findById(session, userId);
    if (user == null) throw UserNotFoundException();

    // åˆ é™¤ç”¨æˆ·ç›¸å…³æ•°æ®
    await _deleteUserData(session, userId);
    await User.db.deleteRow(session, user);

    return true;
  }

  /// è®¾ç½®ç”¨æˆ·ä¸ºç®¡ç†å‘˜ (ä»…ç®¡ç†å‘˜)
  Future<bool> setUserAdmin(Session session, int userId, bool isAdmin) async {
    await _requireAdmin(session);

    final user = await User.db.findById(session, userId);
    if (user == null) throw UserNotFoundException();

    user.isAdmin = isAdmin;
    await User.db.update(session, user);

    return true;
  }

  // === è¾…åŠ©æ–¹æ³• ===

  String _generateTempPassword() {
    final random = Random.secure();
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    return List.generate(8, (_) => chars[random.nextInt(chars.length)]).join();
  }
}
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 å®Œæ•´ ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ username        â”‚
â”‚ passwordHash    â”‚
â”‚ displayName     â”‚
â”‚ avatarPath      â”‚
â”‚ isAdmin         â”‚  â† ç¬¬ä¸€ä¸ªç”¨æˆ·è‡ªåŠ¨ä¸º true
â”‚ isDisabled      â”‚  â† ç®¡ç†å‘˜å¯ç¦ç”¨ç”¨æˆ·
â”‚ mustChangePasswordâ”‚ â† é¦–æ¬¡ç™»å½•éœ€æ”¹å¯†ç 
â”‚ createdAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     scores      â”‚       â”‚    setlists     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ userId (FK)     â”‚       â”‚ userId (FK)     â”‚
â”‚ title           â”‚       â”‚ name            â”‚
â”‚ composer        â”‚       â”‚ description     â”‚
â”‚ bpm             â”‚       â”‚ createdAt       â”‚
â”‚ version         â”‚       â”‚ updatedAt       â”‚
â”‚ createdAt       â”‚       â”‚ deletedAt       â”‚
â”‚ updatedAt       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ deletedAt       â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
         â”‚                         â”‚
         â”‚ 1:N                     â”‚ N:M
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚instrument_scoresâ”‚       â”‚ setlist_scores  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚       â”‚ id (PK)         â”‚
â”‚ scoreId (FK)    â”‚       â”‚ setlistId (FK)  â”‚
â”‚ instrumentType  â”‚       â”‚ scoreId (FK)    â”‚
â”‚ customInstrumentâ”‚       â”‚ position        â”‚
â”‚ pdfPath         â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ thumbnailPath   â”‚
â”‚ fileSize        â”‚
â”‚ createdAt       â”‚
â”‚ updatedAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   annotations   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ instrumentScoreIdâ”‚
â”‚ pageNumber      â”‚
â”‚ annotationType  â”‚
â”‚ color           â”‚
â”‚ strokeWidth     â”‚
â”‚ points (JSONB)  â”‚
â”‚ vectorClock     â”‚  â† CRDT
â”‚ originDeviceId  â”‚  â† CRDT
â”‚ createdAt       â”‚
â”‚ updatedAt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     teams       â”‚       â”‚  team_members   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â”€â”€â”€â”€â”€â”€<â”‚ teamId (FK)     â”‚
â”‚ name            â”‚       â”‚ userId (FK)     â”‚
â”‚ ownerId (FK)    â”‚       â”‚ role            â”‚
â”‚ inviteCode      â”‚       â”‚ joinedAt        â”‚
â”‚ createdAt       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ N:M
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  team_scores    â”‚       â”‚ team_setlists   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ teamId (FK)     â”‚       â”‚ teamId (FK)     â”‚
â”‚ scoreId (FK)    â”‚       â”‚ setlistId (FK)  â”‚
â”‚ sharedBy (FK)   â”‚       â”‚ sharedBy (FK)   â”‚
â”‚ permissions     â”‚       â”‚ permissions     â”‚
â”‚ sharedAt        â”‚       â”‚ sharedAt        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³é”®ç´¢å¼•

```sql
-- åŒæ­¥æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_scores_user_updated ON scores(user_id, updated_at);
CREATE INDEX idx_annotations_instrument_updated ON annotations(instrument_score_id, updated_at);

-- å›¢é˜ŸæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_team_members_user ON team_members(user_id);
CREATE INDEX idx_team_scores_team ON team_scores(team_id);

-- å­˜å‚¨ç»Ÿè®¡
CREATE INDEX idx_instrument_scores_user_size ON instrument_scores(score_id) INCLUDE (file_size);
```

---

## 5. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 5.1 ç”¨æˆ·ç®¡ç†ä¸ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¦–æ¬¡éƒ¨ç½² - ç®¡ç†å‘˜æ³¨å†Œ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ                                                â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  é¦–æ¬¡è®¿é—® â”€â”€â–¶ æ£€æµ‹æ— ç”¨æˆ· â”€â”€â–¶ æ˜¾ç¤ºç®¡ç†å‘˜æ³¨å†Œé¡µé¢                 â”‚
â”‚                                  â”‚                           â”‚
â”‚                                  â–¼                           â”‚
â”‚                          è¾“å…¥ç”¨æˆ·å+å¯†ç                        â”‚
â”‚                                  â”‚                           â”‚
â”‚                                  â–¼                           â”‚
â”‚                          åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·                        â”‚
â”‚                          (isAdmin=true)                      â”‚
â”‚                                  â”‚                           â”‚
â”‚                                  â–¼                           â”‚
â”‚                          è¿›å…¥ç®¡ç†é¢æ¿                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç®¡ç†å‘˜ç™»å½•ç®¡ç†é¢æ¿                                            â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  ç”¨æˆ·ç®¡ç† â”€â”€â–¶ æ·»åŠ ç”¨æˆ·                                         â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â–¼                                           â”‚
â”‚          å¡«å†™: ç”¨æˆ·åã€åˆå§‹å¯†ç ã€æ˜¾ç¤ºåç§°                       â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â–¼                                           â”‚
â”‚          åˆ›å»ºç”¨æˆ· (mustChangePassword=true)                   â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â–¼                                           â”‚
â”‚          å‘ŠçŸ¥ç”¨æˆ·: æœåŠ¡å™¨åœ°å€ + ç”¨æˆ·å + åˆå§‹å¯†ç                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç™»å½•æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  æœ¬åœ°æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ å®Œæ•´åŠŸèƒ½         â”‚
â”‚     â”‚                                          (æ— åŒæ­¥)      â”‚
â”‚     â”‚                                                        â”‚
â”‚     â–¼                                                        â”‚
â”‚  é…ç½®æœåŠ¡å™¨åœ°å€ â”€â”€â–¶ è¾“å…¥ç”¨æˆ·å+å¯†ç  â”€â”€â–¶ ç™»å½•éªŒè¯               â”‚
â”‚                                              â”‚               â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                           â–¼                  â–¼           â–¼   â”‚
â”‚                      [è´¦å·ç¦ç”¨]        [å¯†ç é”™è¯¯]   ç™»å½•æˆåŠŸ  â”‚
â”‚                                                      â”‚       â”‚
â”‚                                               éœ€è¦æ”¹å¯†ç ?    â”‚
â”‚                                              â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”‚
â”‚                                              â–¼       â–¼       â”‚
â”‚                                            [æ˜¯]    [å¦]      â”‚
â”‚                                          å¼ºåˆ¶ä¿®æ”¹  è¿›å…¥App   â”‚
â”‚                                          å¯†ç é¡µé¢   åŒæ­¥æ•°æ®  â”‚
â”‚                                              â”‚               â”‚
â”‚                                              â–¼               â”‚
â”‚                                          ä¿®æ”¹æˆåŠŸ            â”‚
â”‚                                          è¿›å…¥App             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®¡ç†å‘˜æ“ä½œæ±‡æ€»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç”¨æˆ·ç®¡ç†:                                                    â”‚
â”‚  â”œâ”€â”€ åˆ›å»ºç”¨æˆ· (åˆ†é…ç”¨æˆ·å+åˆå§‹å¯†ç )                            â”‚
â”‚  â”œâ”€â”€ æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨                                             â”‚
â”‚  â”œâ”€â”€ é‡ç½®ç”¨æˆ·å¯†ç  (ç”Ÿæˆä¸´æ—¶å¯†ç )                               â”‚
â”‚  â”œâ”€â”€ ç¦ç”¨/å¯ç”¨ç”¨æˆ·                                            â”‚
â”‚  â”œâ”€â”€ è®¾ç½®/å–æ¶ˆç®¡ç†å‘˜æƒé™                                       â”‚
â”‚  â””â”€â”€ åˆ é™¤ç”¨æˆ· (åŒ…æ‹¬å…¶æ•°æ®)                                     â”‚
â”‚                                                              â”‚
â”‚  ç”¨æˆ·æƒé™:                                                    â”‚
â”‚  â””â”€â”€ ä»…èƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é¦–æ¬¡åŒæ­¥ (æœ¬åœ°æ•°æ®è¿ç§»)

```dart
/// ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ï¼Œå°†æœ¬åœ°æ•°æ®è¿ç§»åˆ°äº‘ç«¯
class InitialSyncService {

  Future<SyncReport> performInitialSync(User user) async {
    final report = SyncReport();

    // 1. è·å–æ‰€æœ‰æœ¬åœ°æ•°æ®
    final localScores = await _localDb.getAllScores();
    final localSetlists = await _localDb.getAllSetlists();

    // 2. ä¸Šä¼ ä¹è°±
    for (final score in localScores) {
      try {
        // æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰åŒåä¹è°±
        final cloudScore = await _findCloudScoreByKey(user.id, score.scoreKey);

        if (cloudScore != null) {
          // å­˜åœ¨åŒåï¼šåˆå¹¶åˆ†è°±
          await _mergeInstrumentScores(cloudScore, score);
          report.merged++;
        } else {
          // ä¸å­˜åœ¨ï¼šç›´æ¥ä¸Šä¼ 
          await _uploadScore(user.id, score);
          report.uploaded++;
        }
      } catch (e) {
        report.errors.add(SyncError(score.id, e.toString()));
      }
    }

    // 3. ä¸Šä¼ æ¼”å‡ºå•
    for (final setlist in localSetlists) {
      await _uploadSetlist(user.id, setlist);
      report.setlistsUploaded++;
    }

    return report;
  }
}
```

### 5.3 PDF åå°ä¸Šä¼ ç­–ç•¥

```dart
/// PDF æ–‡ä»¶ä¸Šä¼ æœåŠ¡ (åå°é™é»˜)
class PdfUploadService {
  final _uploadQueue = <UploadTask>[];
  bool _isProcessing = false;

  /// æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
  void scheduleUpload(InstrumentScore instrumentScore, File pdfFile) {
    _uploadQueue.add(UploadTask(
      instrumentScoreId: instrumentScore.id,
      file: pdfFile,
      priority: UploadPriority.normal,
      addedAt: DateTime.now(),
    ));

    _processQueue();
  }

  /// å¤„ç†ä¸Šä¼ é˜Ÿåˆ—
  Future<void> _processQueue() async {
    if (_isProcessing || _uploadQueue.isEmpty) return;
    _isProcessing = true;

    while (_uploadQueue.isNotEmpty) {
      final task = _uploadQueue.removeAt(0);

      try {
        // æ£€æŸ¥ç½‘ç»œæ¡ä»¶
        final connectivity = await _checkConnectivity();
        if (connectivity == ConnectivityResult.none) {
          // æ— ç½‘ç»œï¼Œæ”¾å›é˜Ÿåˆ—ç¨åé‡è¯•
          _uploadQueue.insert(0, task);
          await Future.delayed(Duration(minutes: 1));
          continue;
        }

        // å¤§æ–‡ä»¶ä»…åœ¨ WiFi ä¸‹ä¸Šä¼  (å¯é…ç½®)
        if (task.file.lengthSync() > 10 * 1024 * 1024 && // 10MB
            connectivity != ConnectivityResult.wifi) {
          _uploadQueue.add(task); // æ”¾åˆ°é˜Ÿå°¾
          continue;
        }

        // æ‰§è¡Œä¸Šä¼ 
        await _uploadFile(task);

        // æ›´æ–°åŒæ­¥çŠ¶æ€
        await _markAsSynced(task.instrumentScoreId);

      } catch (e) {
        task.retryCount++;
        if (task.retryCount < 3) {
          _uploadQueue.add(task); // é‡è¯•
        } else {
          _notifyUploadFailed(task, e);
        }
      }
    }

    _isProcessing = false;
  }
}
```

### 5.4 æ‰¹æ³¨ CRDT åŒæ­¥

```dart
/// æ‰¹æ³¨å†²çªè§£å†³ (CRDT: åŸºäº ID çš„åˆå¹¶)
class AnnotationSyncService {

  /// åˆå¹¶æœ¬åœ°å’Œè¿œç¨‹æ‰¹æ³¨
  List<Annotation> mergeAnnotations(
    List<Annotation> local,
    List<Annotation> remote,
  ) {
    final merged = <String, Annotation>{};

    // ä»¥ ID ä¸ºé”®åˆå¹¶
    for (final ann in [...local, ...remote]) {
      final existing = merged[ann.id];

      if (existing == null) {
        merged[ann.id] = ann;
      } else {
        // ç›¸åŒ IDï¼šä¿ç•™æœ€æ–°ç‰ˆæœ¬
        if (ann.updatedAt.isAfter(existing.updatedAt)) {
          merged[ann.id] = ann;
        }
        // å¦‚æœæ—¶é—´ç›¸åŒï¼Œä½¿ç”¨å‘é‡æ—¶é’Ÿæˆ–è®¾å¤‡ ID å†³å®š
        else if (ann.updatedAt == existing.updatedAt) {
          merged[ann.id] = _resolveByVectorClock(ann, existing);
        }
      }
    }

    return merged.values.toList();
  }

  /// å¢é‡åŒæ­¥æ‰¹æ³¨ (é˜²æŠ–: 500ms)
  Future<void> syncAnnotations(
    String instrumentScoreId,
    List<Annotation> localAnnotations,
  ) async {
    // è·å–è¿œç¨‹æ‰¹æ³¨
    final remoteAnnotations = await _fetchRemoteAnnotations(instrumentScoreId);

    // åˆå¹¶
    final merged = mergeAnnotations(localAnnotations, remoteAnnotations);

    // æ‰¾å‡ºéœ€è¦æ¨é€çš„ (æœ¬åœ°æ–°å¢/ä¿®æ”¹)
    final toPush = merged.where((m) {
      final remote = remoteAnnotations.firstWhereOrNull((r) => r.id == m.id);
      return remote == null || m.updatedAt.isAfter(remote.updatedAt);
    }).toList();

    // æ¨é€
    if (toPush.isNotEmpty) {
      await _pushAnnotations(instrumentScoreId, toPush);
    }

    // æ›´æ–°æœ¬åœ°
    await _localDb.saveAnnotations(instrumentScoreId, merged);
  }
}
```

---

## 6. åŒæ­¥æœºåˆ¶è®¾è®¡

### 6.1 åŒæ­¥çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®åŒæ­¥çŠ¶æ€                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚ LOCAL  â”‚  â† æœªç™»å½•æ—¶æ‰€æœ‰æ•°æ®çŠ¶æ€                       â”‚
â”‚     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â”‚
â”‚         â”‚ ç™»å½•                                               â”‚
â”‚         â–¼                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    ä¿®æ”¹    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   åŒæ­¥ä¸­   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”‚ SYNCED â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ PENDING â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚SYNCING â”‚ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                     â–²                    â”‚       â”‚
â”‚         â”‚                     â”‚ å†æ¬¡ä¿®æ”¹            â”‚       â”‚
â”‚         â”‚                     â”‚                    â”‚       â”‚
â”‚         â”‚    æˆåŠŸ             â”‚      å¤±è´¥          â–¼       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                               â”‚ ERROR  â”‚  â”‚
â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åŒæ­¥è§¦å‘æ—¶æœº

| äº‹ä»¶ | åŒæ­¥è¡Œä¸º |
|------|----------|
| ç”¨æˆ·ç™»å½• | å…¨é‡åŒæ­¥ (æ‹‰å– + æ¨é€) |
| åˆ›å»º/ä¿®æ”¹æ•°æ® | æ ‡è®° Pendingï¼Œ5ç§’åæ‰¹é‡æ¨é€ |
| åˆ é™¤æ•°æ® | ç«‹å³åŒæ­¥ (é˜²æ­¢æ•°æ®ä¸¢å¤±) |
| App è¿›å…¥å‰å° | å¢é‡æ‹‰å– (since last_synced) |
| ç½‘ç»œæ¢å¤ | å¤„ç† Pending é˜Ÿåˆ— |
| æ‰‹åŠ¨åˆ·æ–° | å¢é‡æ‹‰å– |

### 6.3 å†²çªå¤„ç†æµç¨‹

```dart
enum ConflictResolution {
  keepLocal,      // ä¿ç•™æœ¬åœ°ç‰ˆæœ¬
  keepRemote,     // ä¿ç•™è¿œç¨‹ç‰ˆæœ¬
  merge,          // åˆå¹¶ (æ‰¹æ³¨ä¸“ç”¨)
  askUser,        // è®©ç”¨æˆ·é€‰æ‹©
}

class ConflictResolver {

  Future<Score> resolveScoreConflict(
    Score local,
    Score remote,
  ) async {
    // å…ƒæ•°æ®å†²çªï¼šLast-Write-Wins
    if (local.updatedAt.isAfter(remote.updatedAt)) {
      return local;
    }
    return remote;
  }

  Future<List<Annotation>> resolveAnnotationConflict(
    List<Annotation> local,
    List<Annotation> remote,
  ) async {
    // æ‰¹æ³¨ï¼šCRDT åˆå¹¶
    return AnnotationSyncService().mergeAnnotations(local, remote);
  }
}
```

---

## 7. Flutter å®¢æˆ·ç«¯å®ç°

### 7.1 æ–°å¢ Service å±‚

```dart
// lib/services/serverpod_client.dart

class ServerpodClientService {
  static Client? _client;
  static SessionManager? _sessionManager;

  static Future<void> initialize() async {
    _client = Client(
      'http://your-server.com/',  // æˆ–æœ¬åœ°å¼€å‘åœ°å€
      authenticationKeyManager: FlutterAuthenticationKeyManager(),
    );

    _sessionManager = SessionManager(
      caller: _client!.modules.auth,
    );
  }

  static Client get client {
    if (_client == null) throw StateError('Client not initialized');
    return _client!;
  }

  static SessionManager get session {
    if (_sessionManager == null) throw StateError('Session not initialized');
    return _sessionManager!;
  }

  static bool get isLoggedIn => _sessionManager?.isSignedIn ?? false;
}
```

```dart
// lib/services/sync_service.dart

class SyncService {
  final Ref _ref;
  Timer? _syncDebouncer;
  final _pendingChanges = <SyncChange>[];

  SyncService(this._ref);

  /// æ ‡è®°æ•°æ®éœ€è¦åŒæ­¥
  void markForSync(String table, String id, SyncOperation op) {
    if (!ServerpodClientService.isLoggedIn) return;

    _pendingChanges.add(SyncChange(table, id, op, DateTime.now()));

    // é˜²æŠ–ï¼š5ç§’åæ‰¹é‡åŒæ­¥
    _syncDebouncer?.cancel();
    _syncDebouncer = Timer(Duration(seconds: 5), _processPendingChanges);
  }

  Future<void> _processPendingChanges() async {
    if (_pendingChanges.isEmpty) return;

    final changes = List<SyncChange>.from(_pendingChanges);
    _pendingChanges.clear();

    // æŒ‰è¡¨åˆ†ç»„å¤„ç†
    final grouped = groupBy(changes, (c) => c.table);

    for (final entry in grouped.entries) {
      switch (entry.key) {
        case 'scores':
          await _syncScores(entry.value);
          break;
        case 'annotations':
          await _syncAnnotations(entry.value);
          break;
        // ...
      }
    }
  }

  /// å…¨é‡åŒæ­¥ (ç™»å½•åè°ƒç”¨)
  Future<SyncReport> performFullSync() async {
    final report = SyncReport();

    // 1. æ‹‰å–è¿œç¨‹æ•°æ®
    final remoteScores = await _client.score.getScores();

    // 2. åˆå¹¶åˆ°æœ¬åœ°
    for (final remote in remoteScores) {
      final local = await _localDb.getScoreById(remote.id.toString());
      if (local == null) {
        // æœ¬åœ°ä¸å­˜åœ¨ï¼šæ’å…¥
        await _localDb.insertScore(_toLocalScore(remote));
        report.pulled++;
      } else {
        // å­˜åœ¨ï¼šæ£€æŸ¥ç‰ˆæœ¬
        if (remote.version > local.version) {
          await _localDb.updateScore(_toLocalScore(remote));
          report.pulled++;
        }
      }
    }

    // 3. æ¨é€æœ¬åœ°æœªåŒæ­¥æ•°æ®
    final localOnly = await _localDb.getUnsyncedScores();
    for (final local in localOnly) {
      await _client.score.upsertScore(_toRemoteScore(local));
      report.pushed++;
    }

    return report;
  }
}
```

### 7.2 Provider æ”¹é€ 

```dart
// lib/providers/auth_provider.dart

@riverpod
class AuthNotifier extends _$AuthNotifier {
  @override
  AuthState build() {
    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
    _checkStoredSession();
    return AuthState.initial();
  }

  Future<void> login(String username, String password) async {
    state = AuthState.loading();

    try {
      final result = await ServerpodClientService.client.auth.login(
        username,
        password,
      );

      if (result.success) {
        // ä¿å­˜ Token
        await _saveAuthToken(result.token);

        state = AuthState.authenticated(result.user);

        // è§¦å‘åˆå§‹åŒæ­¥
        ref.read(syncServiceProvider).performFullSync();
      }
    } catch (e) {
      state = AuthState.error(e.toString());
    }
  }

  Future<void> logout() async {
    await ServerpodClientService.client.auth.logout();
    await _clearAuthToken();
    state = AuthState.initial();
  }
}

// åŒæ­¥çŠ¶æ€ Provider
@riverpod
class SyncStateNotifier extends _$SyncStateNotifier {
  @override
  SyncState build() => SyncState.idle;

  void setSyncing() => state = SyncState.syncing;
  void setSynced() => state = SyncState.synced;
  void setError(String error) => state = SyncState.error(error);
}
```

### 7.3 UI æ”¹é€ ç¤ºä¾‹

```dart
// lib/widgets/sync_status_indicator.dart

class SyncStatusIndicator extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isLoggedIn = ref.watch(authNotifierProvider).isAuthenticated;

    if (!isLoggedIn) {
      // æœªç™»å½•ï¼šæ˜¾ç¤ºæœ¬åœ°æ¨¡å¼
      return Tooltip(
        message: 'æœ¬åœ°æ¨¡å¼ (ç‚¹å‡»ç™»å½•å¼€å¯äº‘åŒæ­¥)',
        child: IconButton(
          icon: Icon(LucideIcons.cloudOff, color: AppColors.gray400),
          onPressed: () => _showLoginDialog(context),
        ),
      );
    }

    final syncState = ref.watch(syncStateNotifierProvider);

    return switch (syncState) {
      SyncState.idle => Icon(LucideIcons.cloud, color: AppColors.gray400),
      SyncState.syncing => SizedBox(
          width: 20,
          height: 20,
          child: CircularProgressIndicator(strokeWidth: 2),
        ),
      SyncState.synced => Icon(LucideIcons.cloudCheck, color: AppColors.emerald500),
      SyncState.error(message: final msg) => Tooltip(
          message: 'åŒæ­¥å¤±è´¥: $msg',
          child: Icon(LucideIcons.cloudAlert, color: AppColors.red500),
        ),
    };
  }
}
```

---

## 8. Web ç®¡ç†é¢æ¿

### 8.1 åŠŸèƒ½è§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MuSheet å›¢é˜Ÿç®¡ç†é¢æ¿                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“Š Dashboard (ä»ªè¡¨ç›˜)                                       â”‚
â”‚  â”œâ”€â”€ å›¢é˜Ÿæˆå‘˜æ€»æ•° / æ´»è·ƒæˆå‘˜                                 â”‚
â”‚  â”œâ”€â”€ ä¹è°±æ€»æ•° / æ¼”å‡ºå•æ€»æ•°                                   â”‚
â”‚  â”œâ”€â”€ å…±äº«èµ„æºç»Ÿè®¡                                            â”‚
â”‚  â””â”€â”€ ç³»ç»Ÿå¥åº·çŠ¶æ€                                            â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘¥ Members (æˆå‘˜ç®¡ç†) â˜… æ ¸å¿ƒåŠŸèƒ½                            â”‚
â”‚  â”œâ”€â”€ æˆå‘˜åˆ—è¡¨ (æœç´¢/ç­›é€‰)                                    â”‚
â”‚  â”œâ”€â”€ åˆ›å»ºæ–°æˆå‘˜ (ç”¨æˆ·å+åˆå§‹å¯†ç )                            â”‚
â”‚  â”œâ”€â”€ é‡ç½®æˆå‘˜å¯†ç  (ç”Ÿæˆä¸´æ—¶å¯†ç )                             â”‚
â”‚  â”œâ”€â”€ ç¦ç”¨/å¯ç”¨æˆå‘˜                                           â”‚
â”‚  â”œâ”€â”€ è®¾ç½®ç®¡ç†å‘˜æƒé™                                          â”‚
â”‚  â””â”€â”€ åˆ é™¤æˆå‘˜                                                â”‚
â”‚                                                             â”‚
â”‚  ğŸ“š Resources (å…±äº«èµ„æº)                                     â”‚
â”‚  â”œâ”€â”€ å›¢é˜Ÿå…±äº«ä¹è°±åˆ—è¡¨                                        â”‚
â”‚  â”œâ”€â”€ å›¢é˜Ÿå…±äº«æ¼”å‡ºå•                                          â”‚
â”‚  â””â”€â”€ èµ„æºä½¿ç”¨ç»Ÿè®¡                                            â”‚
â”‚                                                             â”‚
â”‚  ğŸ’¾ Storage (å­˜å‚¨ç»Ÿè®¡)                                       â”‚
â”‚  â”œâ”€â”€ æ€»å­˜å‚¨ä½¿ç”¨é‡                                            â”‚
â”‚  â”œâ”€â”€ æˆå‘˜å­˜å‚¨æ’è¡Œ                                            â”‚
â”‚  â””â”€â”€ å¤§æ–‡ä»¶åˆ—è¡¨                                              â”‚
â”‚                                                             â”‚
â”‚  âš™ï¸ Settings (ç³»ç»Ÿè®¾ç½®)                                      â”‚
â”‚  â”œâ”€â”€ å›¢é˜Ÿä¿¡æ¯é…ç½®                                            â”‚
â”‚  â”œâ”€â”€ æœåŠ¡å™¨ä¿¡æ¯                                              â”‚
â”‚  â””â”€â”€ æ•°æ®å¤‡ä»½/æ¢å¤                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æŠ€æœ¯å®ç°

```dart
// musheet_admin/lib/main.dart

void main() {
  runApp(ProviderScope(child: AdminApp()));
}

class AdminApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'MuSheet å›¢é˜Ÿç®¡ç†',
      theme: AdminTheme.light,
      routerConfig: _router,
    );
  }

  final _router = GoRouter(
    routes: [
      ShellRoute(
        builder: (context, state, child) => AdminShell(child: child),
        routes: [
          GoRoute(path: '/', builder: (_, __) => DashboardScreen()),
          GoRoute(path: '/members', builder: (_, __) => MembersScreen()),
          GoRoute(path: '/members/:id', builder: (_, state) =>
            MemberDetailScreen(userId: state.pathParameters['id']!)),
          GoRoute(path: '/resources', builder: (_, __) => ResourcesScreen()),
          GoRoute(path: '/storage', builder: (_, __) => StorageScreen()),
          GoRoute(path: '/settings', builder: (_, __) => SettingsScreen()),
        ],
      ),
    ],
  );
}
```

```dart
// musheet_admin/lib/screens/dashboard_screen.dart

class DashboardScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final stats = ref.watch(dashboardStatsProvider);

    return stats.when(
      data: (data) => SingleChildScrollView(
        padding: EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('å›¢é˜Ÿæ¦‚è§ˆ', style: TextStyle(fontSize: 32, fontWeight: FontWeight.bold)),
            SizedBox(height: 24),

            // ç»Ÿè®¡å¡ç‰‡
            Row(
              children: [
                Expanded(child: StatCard(
                  title: 'å›¢é˜Ÿæˆå‘˜',
                  value: '${data.totalMembers}',
                  icon: LucideIcons.users,
                  color: Colors.blue,
                )),
                SizedBox(width: 16),
                Expanded(child: StatCard(
                  title: 'æ´»è·ƒæˆå‘˜ (7å¤©)',
                  value: '${data.activeMembers7d}',
                  icon: LucideIcons.userCheck,
                  color: Colors.green,
                )),
                SizedBox(width: 16),
                Expanded(child: StatCard(
                  title: 'å…±äº«ä¹è°±',
                  value: '${data.sharedScores}',
                  icon: LucideIcons.share,
                  color: Colors.orange,
                )),
                SizedBox(width: 16),
                Expanded(child: StatCard(
                  title: 'æ€»ä¹è°±æ•°',
                  value: '${data.totalScores}',
                  icon: LucideIcons.music,
                  color: Colors.purple,
                )),
              ],
            ),

            SizedBox(height: 32),

            // æœ€è¿‘æ´»åŠ¨
            Card(
              child: Padding(
                padding: EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('æˆå‘˜æ´»åŠ¨è¶‹åŠ¿', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600)),
                    SizedBox(height: 16),
                    SizedBox(
                      height: 300,
                      child: ActivityChart(data: data.activityTrend),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
      loading: () => Center(child: CircularProgressIndicator()),
      error: (e, _) => Center(child: Text('Error: $e')),
    );
  }
}
```

### 8.3 ç®¡ç† API ç«¯ç‚¹

```dart
// musheet_server/lib/src/endpoints/admin_endpoint.dart

class AdminEndpoint extends Endpoint {

  @override
  bool get requireLogin => true;

  @override
  Set<Scope> get requiredScopes => {Scope.admin};

  /// è·å–ä»ªè¡¨ç›˜ç»Ÿè®¡
  Future<DashboardStats> getDashboardStats(Session session) async {
    final totalMembers = await User.db.count(session);
    final activeMembers7d = await _countActiveUsers(session, days: 7);
    final totalScores = await Score.db.count(session);
    final sharedScores = await _countSharedScores(session);
    final totalStorageUsed = await _sumStorageUsed(session);
    final activityTrend = await _getActivityTrend(session, days: 30);

    return DashboardStats(
      totalMembers: totalMembers,
      activeMembers7d: activeMembers7d,
      totalScores: totalScores,
      sharedScores: sharedScores,
      totalStorageUsed: totalStorageUsed,
      activityTrend: activityTrend,
    );
  }

  /// è·å–æˆå‘˜åˆ—è¡¨
  Future<PaginatedResult<UserInfo>> getMembers(
    Session session, {
    int page = 1,
    int pageSize = 20,
    String? search,
    String? sortBy,
  }) async {
    // ... åˆ†é¡µæŸ¥è¯¢é€»è¾‘
  }

  /// è·å–å…±äº«èµ„æºç»Ÿè®¡
  Future<SharedResourcesStats> getSharedResourcesStats(Session session) async {
    final sharedScores = await TeamScore.db.count(session);
    final sharedSetlists = await TeamSetlist.db.count(session);
    final topContributors = await _getTopContributors(session, limit: 10);

    return SharedResourcesStats(
      sharedScores: sharedScores,
      sharedSetlists: sharedSetlists,
      topContributors: topContributors,
    );
  }
}
```

---

## 9. å¼€å‘è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„

```
æ­å»ºé˜¶æ®µ:
â”œâ”€â”€ [ ] æ­å»º Serverpod é¡¹ç›®ç»“æ„
â”œâ”€â”€ [ ] å®šä¹‰æ•°æ®æ¨¡å‹ (Protocol YAML)
â”œâ”€â”€ [ ] å®ç°è®¤è¯ç«¯ç‚¹ (ç®¡ç†å‘˜æ³¨å†Œ/ç”¨æˆ·ç™»å½•)
â”œâ”€â”€ [ ] å®ç°åŸºç¡€ CRUD ç«¯ç‚¹ (Score, Setlist)
â””â”€â”€ [ ] é…ç½®æ•°æ®åº“è¿ç§»

å®¢æˆ·ç«¯é›†æˆ:
â”œâ”€â”€ [ ] Flutter å®¢æˆ·ç«¯é›†æˆ Serverpod Client
â”œâ”€â”€ [ ] å®ç°æœåŠ¡å™¨é…ç½® UI
â”œâ”€â”€ [ ] å®ç°ç™»å½• UI (é¦–æ¬¡éœ€æ”¹å¯†ç )
â”œâ”€â”€ [ ] å®ç°ç¦»çº¿/åœ¨çº¿çŠ¶æ€åˆ‡æ¢
â””â”€â”€ [ ] åŸºç¡€åŒæ­¥åŠŸèƒ½ (æ— å†²çªåœºæ™¯)
```

### Phase 2: åŒæ­¥ä¸å­˜å‚¨

```
æ–‡ä»¶åŒæ­¥:
â”œâ”€â”€ [ ] PDF æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½åŠŸèƒ½
â”œâ”€â”€ [ ] åå°ä¸Šä¼ é˜Ÿåˆ—å®ç°
â”œâ”€â”€ [ ] å¢é‡åŒæ­¥å®ç°
â””â”€â”€ [ ] æ‰¹æ³¨ CRDT åˆå¹¶

UI é›†æˆ:
â”œâ”€â”€ [ ] åŒæ­¥çŠ¶æ€ UI æŒ‡ç¤ºå™¨
â”œâ”€â”€ [ ] å†²çªè§£å†³ UI
â”œâ”€â”€ [ ] å­˜å‚¨ä½¿ç”¨é‡æ˜¾ç¤º
â””â”€â”€ [ ] é¦–æ¬¡ç™»å½•æ•°æ®è¿ç§»
```

### Phase 3: å›¢é˜Ÿåä½œ

```
åç«¯å®ç°:
â”œâ”€â”€ [ ] å›¢é˜Ÿèµ„æºå…±äº« API
â”œâ”€â”€ [ ] å…±äº«æƒé™æ§åˆ¶
â”œâ”€â”€ [ ] åä½œç¼–è¾‘åŒæ­¥
â””â”€â”€ [ ] å®æ—¶é€šçŸ¥ (WebSocket)

å®¢æˆ·ç«¯å®ç°:
â”œâ”€â”€ [ ] å›¢é˜Ÿå…±äº« UI
â”œâ”€â”€ [ ] å…±äº«èµ„æºåˆ—è¡¨
â”œâ”€â”€ [ ] åä½œç¼–è¾‘æ ‡è¯†
â””â”€â”€ [ ] å›¢é˜Ÿæ´»åŠ¨é€šçŸ¥
```

### Phase 4: ç®¡ç†é¢æ¿

```
åŸºç¡€åŠŸèƒ½:
â”œâ”€â”€ [ ] ç®¡ç†é¢æ¿é¡¹ç›®æ­å»º
â”œâ”€â”€ [ ] ç®¡ç†å‘˜è®¤è¯
â”œâ”€â”€ [ ] ä»ªè¡¨ç›˜é¡µé¢
â””â”€â”€ [ ] æˆå‘˜ç®¡ç†é¡µé¢

é«˜çº§åŠŸèƒ½:
â”œâ”€â”€ [ ] å…±äº«èµ„æºç®¡ç†
â”œâ”€â”€ [ ] å­˜å‚¨ç»Ÿè®¡é¡µé¢
â”œâ”€â”€ [ ] ç³»ç»Ÿè®¾ç½®é¡µé¢
â””â”€â”€ [ ] æ•°æ®å¤‡ä»½/æ¢å¤åŠŸèƒ½
```

### Phase 5: ä¼˜åŒ–ä¸å‘å¸ƒ

```
æœ€ç»ˆé˜¶æ®µ:
â”œâ”€â”€ [ ] æ€§èƒ½ä¼˜åŒ–
â”œâ”€â”€ [ ] é”™è¯¯å¤„ç†å®Œå–„
â”œâ”€â”€ [ ] æ—¥å¿—ä¸ç›‘æ§
â”œâ”€â”€ [ ] å®‰å…¨å®¡è®¡
â”œâ”€â”€ [ ] æ–‡æ¡£å®Œå–„
â””â”€â”€ [ ] éƒ¨ç½²ä¸Šçº¿
```

---

## é™„å½•

### A. ç›¸å…³èµ„æº

- [Serverpod å®˜æ–¹æ–‡æ¡£](https://docs.serverpod.dev/)
- [Serverpod GitHub](https://github.com/serverpod/serverpod)
- [Drift (SQLite) æ–‡æ¡£](https://drift.simonbinder.eu/)
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)

### B. ç¯å¢ƒæ­å»º

```bash
# å®‰è£… Serverpod CLI
dart pub global activate serverpod_cli

# åœ¨ musheet é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º server ç›®å½•
mkdir server && cd server

# åˆ›å»º Serverpod é¡¹ç›®
serverpod create musheet

# ç”Ÿæˆä»£ç 
cd musheet_server
serverpod generate

# æœ¬åœ°å¼€å‘å¯åŠ¨
docker-compose up -d  # PostgreSQL + Redis
dart bin/main.dart
```

### C. ç§æœ‰åŒ–éƒ¨ç½²é…ç½®

#### éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç§æœ‰åŒ–éƒ¨ç½²æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 ç”¨æˆ·å†…ç½‘ / ç§æœ‰æœåŠ¡å™¨                 â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  PostgreSQL â”‚  â”‚    Redis    â”‚  â”‚  Serverpod  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚   (æ•°æ®åº“)   â”‚  â”‚   (ç¼“å­˜)    â”‚  â”‚ (API+Admin) â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚         â”‚               â”‚               â”‚          â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                         â”‚                          â”‚   â”‚
â”‚  â”‚                    Docker Network                  â”‚   â”‚
â”‚  â”‚                         â”‚                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚              æ–‡ä»¶å­˜å‚¨ (PDF)                    â”‚â”‚   â”‚
â”‚  â”‚  â”‚         /data/musheet/uploads                 â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚                      å†…ç½‘ IP / åŸŸå                          â”‚
â”‚                  (å¦‚ 192.168.1.100:8080)                    â”‚
â”‚                            â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     å®¢æˆ·ç«¯è®¿é—®                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ æ‰‹æœºApp â”‚  â”‚ å¹³æ¿App â”‚  â”‚ ç”µè„‘App â”‚  â”‚ ç®¡ç†é¢æ¿ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚(å†…ç½‘)   â”‚  â”‚(å†…ç½‘)   â”‚  â”‚(å†…ç½‘)   â”‚  â”‚(æµè§ˆå™¨) â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Docker Compose é…ç½®

```yaml
# server/docker-compose.yml

version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15
    container_name: musheet_db
    environment:
      POSTGRES_USER: musheet
      POSTGRES_PASSWORD: ${DB_PASSWORD:-musheet_secure_password}
      POSTGRES_DB: musheet
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - musheet_network
    restart: unless-stopped

  # Redis (Serverpod ä¼šè¯ç®¡ç†)
  redis:
    image: redis:7-alpine
    container_name: musheet_redis
    volumes:
      - ./data/redis:/data
    networks:
      - musheet_network
    restart: unless-stopped

  # Serverpod åç«¯ + ç®¡ç†é¢æ¿
  server:
    build:
      context: ./musheet_server
      dockerfile: Dockerfile
    container_name: musheet_server
    ports:
      - "${SERVER_PORT:-8080}:8080"   # API ç«¯å£
      - "${ADMIN_PORT:-8082}:8082"    # Web ç®¡ç†é¢æ¿ç«¯å£
    environment:
      # æ•°æ®åº“é…ç½®
      - SERVERPOD_DATABASE_HOST=postgres
      - SERVERPOD_DATABASE_PORT=5432
      - SERVERPOD_DATABASE_NAME=musheet
      - SERVERPOD_DATABASE_USER=musheet
      - SERVERPOD_DATABASE_PASSWORD=${DB_PASSWORD:-musheet_secure_password}
      # Redis é…ç½®
      - SERVERPOD_REDIS_HOST=redis
      - SERVERPOD_REDIS_PORT=6379
      # æœåŠ¡å™¨é…ç½®
      - SERVER_URL=${SERVER_URL:-http://localhost:8080}
      - ADMIN_URL=${ADMIN_URL:-http://localhost:8082}
    depends_on:
      - postgres
      - redis
    networks:
      - musheet_network
    volumes:
      - ./data/uploads:/app/uploads    # PDF æ–‡ä»¶å­˜å‚¨
      - ./data/thumbnails:/app/thumbnails  # ç¼©ç•¥å›¾å­˜å‚¨
    restart: unless-stopped

networks:
  musheet_network:
    driver: bridge
```

#### ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶

```bash
# server/.env (éƒ¨ç½²æ—¶åˆ›å»º)

# æ•°æ®åº“å¯†ç  (è¯·ä¿®æ”¹ä¸ºå¼ºå¯†ç )
DB_PASSWORD=your_secure_password_here

# æœåŠ¡å™¨åœ°å€ (æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹)
# å†…ç½‘éƒ¨ç½²ç¤ºä¾‹
SERVER_URL=http://192.168.1.100:8080
ADMIN_URL=http://192.168.1.100:8082

# ç«¯å£é…ç½®
SERVER_PORT=8080
ADMIN_PORT=8082
```

#### ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# server/deploy.sh

echo "=== MuSheet ç§æœ‰åŒ–éƒ¨ç½² ==="

# æ£€æŸ¥ Docker
if ! command -v docker &> /dev/null; then
    echo "é”™è¯¯: è¯·å…ˆå®‰è£… Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "é”™è¯¯: è¯·å…ˆå®‰è£… Docker Compose"
    exit 1
fi

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data/postgres data/redis data/uploads data/thumbnails

# æ£€æŸ¥ .env æ–‡ä»¶
if [ ! -f .env ]; then
    echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ .env ..."
    cat > .env << EOF
DB_PASSWORD=$(openssl rand -base64 32)
SERVER_URL=http://$(hostname -I | awk '{print $1}'):8080
ADMIN_URL=http://$(hostname -I | awk '{print $1}'):8082
SERVER_PORT=8080
ADMIN_PORT=8082
EOF
    echo "å·²ç”Ÿæˆ .env æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥å¹¶æŒ‰éœ€ä¿®æ”¹"
fi

# æ„å»ºå¹¶å¯åŠ¨
echo "æ­£åœ¨æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
docker-compose up -d --build

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if docker-compose ps | grep -q "Up"; then
    echo ""
    echo "=== éƒ¨ç½²æˆåŠŸ ==="
    echo ""
    echo "API åœ°å€: $(grep SERVER_URL .env | cut -d= -f2)"
    echo "ç®¡ç†é¢æ¿: $(grep ADMIN_URL .env | cut -d= -f2)"
    echo ""
    echo "é¦–æ¬¡è®¿é—®ç®¡ç†é¢æ¿æ³¨å†Œçš„ç”¨æˆ·å°†è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜"
    echo ""
else
    echo "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker-compose logs"
    exit 1
fi
```

#### Dockerfile

```dockerfile
# server/musheet_server/Dockerfile

FROM dart:stable AS build

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY pubspec.* ./
RUN dart pub get

# å¤åˆ¶æºä»£ç å¹¶ç¼–è¯‘
COPY . .
RUN dart compile exe bin/main.dart -o bin/server

# ç”Ÿäº§é•œåƒ
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# å¤åˆ¶ç¼–è¯‘äº§ç‰©
COPY --from=build /app/bin/server ./bin/server
COPY --from=build /app/config ./config
COPY --from=build /app/web ./web
COPY --from=build /app/migrations ./migrations

# åˆ›å»ºä¸Šä¼ ç›®å½•
RUN mkdir -p /app/uploads /app/thumbnails

EXPOSE 8080 8082

CMD ["./bin/server", "--mode", "production"]
```

#### å®¢æˆ·ç«¯é…ç½®æœåŠ¡å™¨åœ°å€

```dart
// lib/services/server_config.dart

class ServerConfig {
  static String? _serverUrl;

  /// è·å–æœåŠ¡å™¨åœ°å€ (ä»æœ¬åœ°å­˜å‚¨è¯»å–)
  static Future<String?> getServerUrl() async {
    if (_serverUrl != null) return _serverUrl;

    final prefs = await SharedPreferences.getInstance();
    _serverUrl = prefs.getString('server_url');
    return _serverUrl;
  }

  /// è®¾ç½®æœåŠ¡å™¨åœ°å€ (ç”¨æˆ·é¦–æ¬¡é…ç½®)
  static Future<void> setServerUrl(String url) async {
    _serverUrl = url;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('server_url', url);
  }

  /// æµ‹è¯•æœåŠ¡å™¨è¿æ¥
  static Future<bool> testConnection(String url) async {
    try {
      final client = Client(url);
      await client.status.getStatus();  // è°ƒç”¨å¥åº·æ£€æŸ¥ API
      return true;
    } catch (e) {
      return false;
    }
  }
}
```

```dart
// lib/screens/server_setup_screen.dart

/// é¦–æ¬¡å¯åŠ¨æ—¶é…ç½®æœåŠ¡å™¨åœ°å€
class ServerSetupScreen extends StatefulWidget {
  @override
  State<ServerSetupScreen> createState() => _ServerSetupScreenState();
}

class _ServerSetupScreenState extends State<ServerSetupScreen> {
  final _urlController = TextEditingController();
  bool _testing = false;
  String? _error;

  Future<void> _testAndSave() async {
    setState(() { _testing = true; _error = null; });

    final url = _urlController.text.trim();
    final success = await ServerConfig.testConnection(url);

    if (success) {
      await ServerConfig.setServerUrl(url);
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (_) => LoginScreen()),
      );
    } else {
      setState(() {
        _testing = false;
        _error = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Padding(
          padding: EdgeInsets.all(32),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text('é…ç½®æœåŠ¡å™¨', style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
              SizedBox(height: 8),
              Text('è¯·è¾“å…¥æ‚¨çš„ MuSheet æœåŠ¡å™¨åœ°å€', style: TextStyle(color: Colors.grey)),
              SizedBox(height: 32),
              TextField(
                controller: _urlController,
                decoration: InputDecoration(
                  labelText: 'æœåŠ¡å™¨åœ°å€',
                  hintText: 'http://192.168.1.100:8080',
                  prefixIcon: Icon(Icons.dns),
                  errorText: _error,
                ),
              ),
              SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: _testing ? null : _testAndSave,
                  child: _testing
                      ? SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2))
                      : Text('è¿æ¥'),
                ),
              ),
              SizedBox(height: 16),
              Text(
                'æç¤º: è¯·è”ç³»å›¢é˜Ÿç®¡ç†å‘˜è·å–æœåŠ¡å™¨åœ°å€',
                style: TextStyle(fontSize: 12, color: Colors.grey),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

### D. å·²ç¡®è®¤äº‹é¡¹

| äº‹é¡¹ | å†³ç­– |
|------|------|
| âœ… éƒ¨ç½²æ–¹å¼ | ç§æœ‰åŒ–éƒ¨ç½² (Docker å®¹å™¨åŒ–) |
| âœ… è´¦å·ç®¡ç† | ç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†ï¼Œåˆ›å»º/åˆ é™¤ç”¨æˆ· |
| âœ… ç”¨æˆ·æƒé™ | ç”¨æˆ·ä»…èƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç  |
| âœ… é¦–ä¸ªç”¨æˆ· | è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜ |
| âœ… ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| âœ… å®¢æˆ·ç«¯é…ç½® | æœåŠ¡å™¨åœ°å€ + ç”¨æˆ·å + å¯†ç  |

### E. å¾…å‡†å¤‡äº‹é¡¹

**éƒ¨ç½²æœåŠ¡å™¨éœ€è¦ï¼š**
1. **æœåŠ¡å™¨**: ä»»æ„ Linux æœåŠ¡å™¨ (æ¨è 2æ ¸4G èµ·æ­¥)ï¼Œå¯ä»¥æ˜¯å†…ç½‘æœºå™¨
2. **Docker**: å®‰è£… Docker å’Œ Docker Compose
3. **ç½‘ç»œ**: ç¡®ä¿å®¢æˆ·ç«¯è®¾å¤‡èƒ½è®¿é—®æœåŠ¡å™¨ IP å’Œç«¯å£

**å¯é€‰é…ç½®ï¼š**
1. **åŸŸå + SSL**: å¦‚éœ€å…¬ç½‘è®¿é—®ï¼Œå‡†å¤‡åŸŸåå’Œè¯ä¹¦
2. **å¤‡ä»½**: é…ç½®æ•°æ®ç›®å½•å®šæœŸå¤‡ä»½

### F. ç§æœ‰åŒ–éƒ¨ç½²å¿«é€ŸæŒ‡å—

```bash
# 1. åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºç›®å½•
mkdir -p /opt/musheet && cd /opt/musheet

# 2. ä¸‹è½½éƒ¨ç½²æ–‡ä»¶ (æˆ–ä» Git å…‹éš†)
git clone https://github.com/your-repo/musheet-server.git server
cd server

# 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
chmod +x deploy.sh
./deploy.sh

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 6. åœæ­¢æœåŠ¡
docker-compose down

# 7. æ›´æ–°æœåŠ¡
git pull
docker-compose up -d --build
```

**å›¢é˜Ÿä½¿ç”¨æµç¨‹ï¼š**

1. **ç®¡ç†å‘˜éƒ¨ç½²æœåŠ¡å™¨**
   - å®‰è£… Docker å¹¶è¿è¡Œéƒ¨ç½²è„šæœ¬
   - è®°å½•æœåŠ¡å™¨åœ°å€ (å¦‚ `http://192.168.1.100:8080`)

2. **ç®¡ç†å‘˜åˆå§‹åŒ–**
   - é¦–æ¬¡è®¿é—®ç®¡ç†é¢æ¿ `http://192.168.1.100:8082`
   - åˆ›å»ºç®¡ç†å‘˜è´¦å· (è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜)

3. **åˆ›å»ºå›¢é˜Ÿæˆå‘˜è´¦å·**
   - åœ¨ç®¡ç†é¢æ¿ä¸­æ·»åŠ æˆå‘˜
   - ä¸ºæ¯ä¸ªæˆå‘˜åˆ†é…ç”¨æˆ·åå’Œåˆå§‹å¯†ç 

4. **æˆå‘˜é…ç½®å®¢æˆ·ç«¯**
   - å®‰è£… MuSheet App
   - é¦–æ¬¡å¯åŠ¨æ—¶è¾“å…¥æœåŠ¡å™¨åœ°å€
   - ä½¿ç”¨ç®¡ç†å‘˜åˆ†é…çš„è´¦å·ç™»å½•
   - é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç 

5. **å¼€å§‹åä½œ**
   - æˆå‘˜ç®¡ç†ä¸ªäººä¹è°±åº“
   - å‘å›¢é˜Ÿå…±äº«ä¹è°±å’Œæ¼”å‡ºå•
   - è®¿é—®å›¢é˜Ÿå…±äº«èµ„æº

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0*
*æ›´æ–°æ—¥æœŸ: 2024-12*
*æ¨¡å¼: å›¢é˜Ÿå†…éƒ¨ç®¡ç†*
