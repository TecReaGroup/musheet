项目名称：MuSheet

**项目背景：**
我们要开发一款基于 Flutter 的跨平台（iOS/Android/Pad端优先）乐谱管理软件。核心痛点是解决纸质乐谱携带不便、团队排练分发乐谱效率低的问题。

**核心功能模块与细节要求：**

#### 1. 乐谱阅读器 (Score Viewer - 核心体验)

这是应用最关键的部分，要求极致的流畅和稳定性。

- **PDF 高性能渲染：** 支持加载超大体积 PDF，要求无卡顿。支持双指缩放、平滑滚动、快速跳转页面。
- **翻页模式：**
  - *仿真翻页*与*垂直滚动*两种模式切换。
  - **蓝牙踏板支持：** 必须支持通过蓝牙外设（如 PageFlip, AirTurn）控制翻页（模拟键盘事件），这是乐手演出的刚需。
  - **半页翻页/智能视线：** 竖屏模式下支持下半页预加载，避免翻页瞬间的视觉中断。
- **标注系统 (Annotation Layer)：**
  - 在 PDF 上层覆盖透明 Canvas。
  - 支持手写笔（Apple Pencil/Stylus）书写，包括画笔，橡皮等，支持颜色粗细等选择。
  - 支持标注的撤销/重做，以及“只看原谱”的一键隐藏标注功能。
- 拓展功能：**辅助工具：** 内置节拍器（悬浮窗）、简单录音功能（用于排练回放）。

#### 2. 乐谱库管理 (Library Management)

- **管理分类：**
  - **元数据：** 乐谱名、作者。
  - 所有乐谱都收录到谱库中
  - **自定歌单：**用户可创建歌单。
- **歌单(Setlists)：**
  - 这是一个虚拟分组，不复制文件。允许用户从谱库中导入乐谱（或者直接导入乐谱到歌单，后台添加到谱库中），允许将不同乐谱按演出顺序排列。
  - 支持“拖拽排序”。
- **导入方式：** 支持从系统文件导入 PDF，或者、微信/AirDrop、以及云盘什么的分享 PDF 到 MuSheet。

#### 3. 团队协作与共享 (Team & Cloud)

  有团队谱库和团队歌单

- **组织架构：**
  - 支持创建“乐队/团队”。
  - **角色权限：** 管理员（上传、删除、管理成员，有多个管理员）、普通成员（仅查看、下载）。
- **实时分发：** 管理员上传歌单后，团队成员端自动同步，本地缓存。
- **标注共享（亮点功能）：**
  - 标记可以共享并且自己选择查看哪个标记。
- **离线优先 (Offline First)：** 考虑到演出场地可能无网络，必须采用本地数据库优先策略，有网时再进行云端同步。

#### 4. 技术与架构要求

- **状态管理：** 推荐使用 Riverpod 或 Bloc。
- **本地存储：** 使用 Isar 或 Hive 存储元数据，文件系统存储 PDF 实体。
- **后端服务：** 推荐 Firebase 或 Supabase（用于处理鉴权、文件存储 Storage 和实时数据库）。
- **UI/UX：** 必须适配平板的大屏操作，ipad 和 手机 的布局逻辑，UI 极简风格，UX 流畅体验良好。再适配  Web 端。

## 架构设计：
针对流行音乐、多乐器分轨、以及“聚合管理”的需求，最科学的方案是采用 **“作品（Song）- 分谱（Part/Track）” 的二级层级结构**。

即使你只有一份 PDF，你也应该先创建一个“歌曲”条目，然后把 PDF 挂载在下面。这样当你有同一个首歌的吉他谱、鼓谱、贝斯谱时，它们会自动聚合在一起，而不是散落在列表中。

以下是为你量身定制的完整元数据方案和管理逻辑：

### 1. 核心架构思想：One-Song-Many-Parts (一对多)

不要让用户直接对着一堆 PDF 文件操作。

- **第一层级（入口）：** **Song (乐曲)** —— 这是管理的最小单位。
- **第二层级（内容）：** **ScoreAsset (分谱文件)** —— 点击歌曲进入后，展示该歌曲下所有的文件变体。

### 2. 详细元数据设计 (Metadata Schema)

我们需要将元数据拆分为“歌曲通用信息”和“分谱特定信息”。

#### A. 歌曲层级 (Song Metadata) - *定义这首歌是什么*

这些信息对于这首歌的所有乐器谱都是通用的：

| 字段名           | 建议类型 | 说明/举例 | 流行乐特别考量                                 |
| ---------------- | -------- | --------- | ---------------------------------------------- |
| **Title**        | String   | 歌曲名    | 支持别名 (如: *稻香 / Dao Xiang*)              |
| **Artist**       | String   | 原唱/歌手 | 流行乐大家通常搜歌手，而不是作曲家             |
| **Album**        | String   | 专辑名    | 同一首歌不同专辑版本可能不同 (Live版/录音室版) |
| **BPM**          | Int      | 速度      | 决定节拍器默认速度                             |
| **Original Key** | String   | 原调      | 例如: C Major, F# Minor                        |
| **Time Sig**     | String   | 拍号      | 4/4, 6/8                                       |
| **Duration**     | String   | 时长      | 3:45 (用于排练预估时间)                        |
| **Tags**         | List     | 标签      | 风格(Funk, Rock), 场景(婚礼, 酒吧)             |

#### B. 分谱层级 (Score Asset Metadata) - *定义这个文件给谁看*

这是你“点进去后”选择的具体内容。

| 字段名            | 建议类型 | 说明/举例       | 核心作用                                                     |
| ----------------- | -------- | --------------- | ------------------------------------------------------------ |
| **Instrument**    | Enum     | **乐器类型**    | **最关键字段**。例如：Vocal, Guitar, Bass, Drums, Keyboard, Full Score (总谱) |
| **Type**          | Enum     | 谱面类型        | 五线谱 (Notation), 六线谱 (Tab), 简谱 (Numbered), 和弦谱 (Chord Chart), 歌词本 (Lyrics) |
| **Transposition** | String   | 移调/当前调性   | 歌手可能要降调唱，这里记录该PDF是“Eb调”的                    |
| **Capo**          | Int      | 变调夹 (仅吉他) | 例如: Capo 2 (流行吉他手刚需)                                |
| **Role**          | List     | 适用角色        | 标记该谱子给谁看 (关联团队权限)                              |

------



### 3. UI/UX 交互逻辑方案

为了实现你想要的整洁效果，建议采用以下交互流程：

#### 列表页 (Song List)

- **展示：** 只展示歌曲标题、歌手、和一些关键标签（如 BPM、原调）。
- **视觉聚合：** 如果这首歌下面包含 4 个分谱（吉他、贝斯、鼓、键盘），可以在卡片角落显示 4 个小图标，提示用户资源很全。
- **搜索：** 搜“周杰伦”能搜出所有他的歌，而不是搜出一堆乱七八糟的“周杰伦-鼓谱”、“周杰伦-吉他”。

#### 详情页 (Song Detail / Dashboard)

点击某首歌后，弹出一个底部面板（Bottom Sheet）或进入详情页，包含两个区域：

1. **Meta Area (信息区)：** 显示 BPM、节拍器开关、原曲音频播放（用于对着练）。
2. **Parts Selector (分谱选择区) —— \*这是重点\*：**
   - **智能排序：** 这是一个列表。
   - *用户偏好优先：* 如果当前 App 登录用户设置自己是“鼓手”，那么“Drums”的分谱自动排在第一个并高亮。
   - *分组展示：*
     - 🎸 **Rhythm Section:** Guitar (Tab), Bass
     - 🥁 **Percussion:** Drums
     - 🎹 **Keys/Synth:** Piano, Synth Pad
     - 🎤 **Vocal:** Lead Vocal, Harmony
   - **快速切换：** 在看谱界面，顶部导航栏应该允许快速切换同歌曲下的其他乐器（例如吉他手有时候想看一眼贝斯的律动）。



### 4. 团队协作中的“智能分发”

基于上述元数据，你的团队共享功能会变得非常强大：

- **场景：** 队长上传了一首《Yellow》，里面打包了 4 个 PDF（总谱、吉他、鼓、贝斯）。
- **结果：**
  - **鼓手** 打开 iPad，点开《Yellow》，系统默认直接打开 **Drums** 的 PDF。
  - **主唱** 打开 iPad，点开《Yellow》，系统默认直接打开 **Lyrics + Chords** 的 PDF。



### 5. 完善后的 Prompt (针对数据结构与流行乐优化)

你可以把这段 Prompt 给 AI，让它帮你生成具体的 Data Class 代码和数据库 Schema：

> **角色补充：**
> 你需要特别针对“流行乐队（Pop/Rock Band）”的场景优化数据结构。
>
> **核心需求变更：**
> 我希望采用 **“Song (作品) -> Parts (分谱)”** 的二级层级结构，避免文件列表杂乱。
>
> **请为我完成以下任务：**
>
> 1. **设计 Data Model (Dart/Flutter)：**
>    - 设计一个 Song 类，包含流行乐所需的元数据（如 Title, Artist, BPM, Original Key, SpotifyLink 等）。
>    - 设计一个 ScorePart 类，作为 Song 的子项。必须包含 Instrument (枚举类型：Guitar, Bass, Drums, Vocal, Keyboard, Saxophone, Others), ScoreType (枚举：StandardNotation, Tab, ChordSheet, LeadSheet), 和 FileUrl。
>    - 吉他谱要有专门的字段记录 Capo (变调夹位置)。
> 2. **设计 UI 交互逻辑 (文字描述)：**
>    - 描述列表页如何仅展示 Song 信息。
>    - 描述点击歌曲后，如何根据当前用户的“乐器偏好(Instrument Preference)”自动推荐打开最匹配的 ScorePart，同时允许手动选择其他分谱。
> 3. **Supabase 数据库设计：**
>    - 请写出 SQL 建表语句（PostgreSQL），包括 songs 表, score_parts 表，以及它们的一对多关联。
>    - 设计一个 user_profiles 表，记录用户的“主修乐器”，用于上述的智能推荐逻辑。

### 总结推荐

对于流行乐管理，**“歌曲信息”与“乐器分轨”分离**是最佳实践。

- **推荐方案：** 类似 **ForScore** (利用 Metadata) 或 **Planning Center Music Stand** (专业的团队分谱管理) 的逻辑。
- **亮点：** 加入 **Instrument** 和 **Capo/Key** 字段是区分专业与业余软件的关键。