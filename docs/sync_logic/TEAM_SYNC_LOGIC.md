# MuSheet Team 同步逻辑

本文档描述 MuSheet Flutter App 的 Team（团队）功能同步架构，采用与个人库相同的**元数据通道**与**文件通道**分离设计，但 Team 数据完全独立于个人库。

---

## 目录

1. [总体设计原则](#1-总体设计原则)
2. [数据模型](#2-数据模型)
3. [导入与创建逻辑](#3-导入与创建逻辑)
4. [同步流程](#4-同步流程)
5. [PDF 文件处理](#5-pdf-文件处理)
6. [冲突解决](#6-冲突解决)
7. [特殊场景](#7-特殊场景)

---

## 1. 总体设计原则

### 1.1 核心架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Team 同步架构                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌──────────────────┐              ┌──────────────────┐            │
│   │     个人库        │              │      Team 库      │            │
│   │   (独立数据)      │    复制 →    │    (独立数据)     │            │
│   ├──────────────────┤              ├──────────────────┤            │
│   │ Score            │              │ TeamScore        │            │
│   │ InstrumentScore  │  ─────────►  │ TeamInstrumentScore│           │
│   │ Setlist          │              │ TeamSetlist      │            │
│   │ SetlistScore     │              │ TeamSetlistScore │            │
│   └──────────────────┘              └──────────────────┘            │
│                                            │                         │
│                                            ▼                         │
│                                     共享 PDF 存储                    │
│                                     (基于 pdfHash)                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| **数据独立** | Team 数据完全独立于个人库，采用复制模式而非引用模式 |
| **PDF 复用** | Team 和个人库共享 PDF 存储，基于 pdfHash 去重 |
| **智能下载** | PDF 后台预加载，优先下载当前打开的内容（与个人库一致） |
| **成员平等** | 所有成员都有相同的编辑权限（只有 member 一种角色） |
| **唯一性约束** | 同一 Team 中不允许存在同名 (title + composer) 的 Score 或同名 Setlist |
| **本地优先** | UI 操作立即写入本地，后台异步同步 |
| **入口唯一** | Team 内容只能通过 Team 界面的 Add 按钮添加，个人库无"复制到团队"选项 |
| **拒绝重复** | 从 Library 导入时，若 Team 中已有同名 Score/Setlist 则拒绝导入 |

### 1.3 与个人库的区别

| 对比项 | 个人库 | Team |
|--------|--------|------|
| 数据所有权 | 单用户 | 多用户共享 |
| 版本号 | libraryVersion | teamLibraryVersion (每个 Team 独立) |
| 冲突来源 | 多设备 | 多用户 + 多设备 |
| PDF 下载 | 后台预加载 + 按需下载 | 后台预加载 + 按需下载（与个人库一致） |
| 导入方式 | 直接创建 | 直接创建 或 从 Library 导入（通过 Add 按钮） |
| 添加分谱 | 任何时候可添加 | 任何时候可添加（与个人库一致） |
| 复制分谱 | 支持 | 支持（与个人库一致） |
| 从库导入分谱 | N/A | 支持选择 Score 后再选择乐器导入 |

---

## 2. 数据模型

### 2.1 实体关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Team 实体关系                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Team (团队)                                                        │
│  ├── id (PK)                                                        │
│  ├── name                                                           │
│  ├── createdById (创建者 userId)                                    │
│  └── createdAt, updatedAt, deletedAt                                │
│  注: 成员管理通过后端 WebUI 进行，无邀请码机制                        │
│       │                                                             │
│       │ 1:N                                                         │
│       ▼                                                             │
│  TeamMember (团队成员)                                               │
│  ├── id (PK)                                                        │
│  ├── teamId (FK → Team)                                             │
│  ├── userId (FK → User)                                             │
│  ├── role = 'member' (唯一角色，所有成员平等)                         │
│  └── joinedAt                                                       │
│                                                                      │
│  ═══════════════════════════════════════════════════════════════════ │
│                                                                      │
│  TeamScore (团队乐谱)                                                │
│  ├── id (PK)                                                        │
│  ├── teamId (FK → Team)                                             │
│  ├── title                                                          │
│  ├── composer                                                       │
│  ├── bpm                                                            │
│  ├── createdById (创建/导入者 userId)                                │
│  ├── sourceScoreId (nullable, 从个人库复制时记录来源 serverId)        │
│  ├── syncStatus ('pending' | 'synced')                              │
│  ├── version (int)                                                  │
│  └── createdAt, updatedAt, deletedAt                                │
│       │                                                             │
│       │ 1:N                                                         │
│       ▼                                                             │
│  TeamInstrumentScore (团队分谱)                                      │
│  ├── id (PK)                                                        │
│  ├── teamScoreId (FK → TeamScore)                                   │
│  ├── instrumentType                                                 │
│  ├── customInstrument                                               │
│  ├── pdfHash (MD5, 复用全局 PDF 存储)                                │
│  ├── pdfPath (本地路径)                                              │
│  ├── pdfSyncStatus ('pending' | 'synced' | 'needsDownload')         │
│  ├── annotationsJson (Team 独立标注，从个人库复制时会复制)            │
│  ├── sourceInstrumentScoreId (nullable)                             │
│  ├── syncStatus, version                                            │
│  └── createdAt, updatedAt, deletedAt                                │
│                                                                      │
│  ═══════════════════════════════════════════════════════════════════ │
│                                                                      │
│  TeamSetlist (团队曲单)                                              │
│  ├── id (PK)                                                        │
│  ├── teamId (FK → Team)                                             │
│  ├── name                                                           │
│  ├── description                                                    │
│  ├── createdById                                                    │
│  ├── sourceSetlistId (nullable)                                     │
│  ├── syncStatus, version                                            │
│  └── createdAt, updatedAt, deletedAt                                │
│       │                                                             │
│       │ 1:N                                                         │
│       ▼                                                             │
│  TeamSetlistScore (团队曲单关联)                                     │
│  ├── id (PK)                                                        │
│  ├── teamSetlistId (FK → TeamSetlist)                               │
│  ├── teamScoreId (FK → TeamScore)  ← 注意：引用的是 TeamScore        │
│  ├── orderIndex                                                     │
│  ├── syncStatus, version                                            │
│  └── createdAt, updatedAt, deletedAt                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 唯一性约束

| 实体 | 唯一键 | 说明 |
|------|--------|------|
| TeamScore | (teamId, title, composer) | 同一 Team 中不允许同名曲目 |
| TeamInstrumentScore | (teamScoreId, instrumentType, customInstrument) | 同一 Score 中不允许重复乐器 |
| TeamSetlist | (teamId, name) | 同一 Team 中不允许同名曲单 |
| TeamSetlistScore | (teamSetlistId, teamScoreId) | 同一曲单中不允许重复曲目 |

### 2.3 同步状态表

每个 Team 维护独立的同步版本：

```
TeamSyncState (本地表)
├── teamId (PK)
├── teamLibraryVersion (该团队的版本号)
└── lastSyncAt
```

### 2.4 同步字段规范

每个 Team 实体都包含以下同步字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | INT | 服务器端主键 |
| `syncStatus` | TEXT | `pending` / `synced` |
| `version` | INT (64-bit) | 该记录的版本号 |
| `updatedAt` | DATETIME | 最后更新时间 |
| `deletedAt` | DATETIME? | 软删除时间戳 |

---

## 3. 导入与创建逻辑

### 3.0 入口限制

**重要：Team 内容只能通过右下角的 Add 按钮添加**

```
┌─────────────────────────────────────────────────────────────────────┐
│  Team 内容添加入口                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────────────────────────────┐            │
│  │                    Team 界面                         │            │
│  │                                                      │            │
│  │                                                      │            │
│  │                                                      │            │
│  │                                                      │            │
│  │                                    ┌──────────────┐  │            │
│  │                                    │      +       │  │ ← 右下角   │
│  │                                    │  Add 按钮    │  │   FAB      │
│  │                                    └──────────────┘  │            │
│  └─────────────────────────────────────────────────────┘            │
│                              │                                       │
│                              │ 点击                                  │
│                              ▼                                       │
│                    ┌─────────────────────┐                          │
│                    │   选择添加方式       │                          │
│                    ├─────────────────────┤                          │
│                    │ 📄 直接创建          │ → 导入新 PDF 创建        │
│                    │ 📥 从 Library 导入   │ → 从个人库选择复制       │
│                    └─────────────────────┘                          │
│                                                                      │
│  注意: 个人库界面没有"复制到团队"选项，必须在 Team 界面操作           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.1 创建 TeamScore 的两种方式

```
┌─────────────────────────────────────────────────────────────────────┐
│  创建 TeamScore 的两种方式                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  方式 1: 直接创建 (导入新 PDF)                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 用户点击 Add 按钮 → 选择 "直接创建"                             │ │
│  │ → 选择 PDF 文件并输入 title/composer                           │ │
│  │ → 创建 TeamScore (sourceScoreId = null)                        │ │
│  │ → 创建 TeamInstrumentScore                                     │ │
│  │ → 上传 PDF (使用全局 pdfHash 机制)                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  方式 2: 从 Library 导入                                             │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 用户点击 Add 按钮 → 选择 "从 Library 导入"                      │ │
│  │ → 显示个人库列表，选择 Score 或 Setlist                         │ │
│  │ → 复制 Score 元数据 → TeamScore (sourceScoreId = 原 serverId)  │ │
│  │ → 联级复制所有 InstrumentScore → TeamInstrumentScore            │ │
│  │ → 联级复制 annotationsJson（Team 独立副本）                      │ │
│  │ → pdfHash 直接复制（与本地 Library 共用 PDF 文件）               │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 从 Library 导入 Score 的流程

**重要：不支持导入重复的 Score！**

```
┌─────────────────────────────────────────────────────────────────────┐
│  从 Library 导入 Score 到 Team                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                    ┌─────────────────────┐                          │
│                    │ 用户在 Add 菜单选择  │                          │
│                    │ "从 Library 导入"    │                          │
│                    │ → 选择 Score         │                          │
│                    └──────────┬──────────┘                          │
│                               │                                      │
│                               ▼                                      │
│            ┌──────────────────────────────────┐                     │
│            │ 检查: Team 中是否已有同名 Score？ │                     │
│            │ WHERE teamId = ? AND title = ?   │                     │
│            │   AND composer = ?               │                     │
│            └─────────────────┬────────────────┘                     │
│                      ┌───────┴───────┐                              │
│                     YES              NO                              │
│                      │               │                               │
│                      ▼               ▼                               │
│         ┌────────────────────┐  ┌────────────────────────────┐      │
│         │ ❌ 拒绝导入         │  │ ✅ 执行导入                 │      │
│         │                    │  │                            │      │
│         │ 提示: "团队中已有   │  │ 1. 创建 TeamScore          │      │
│         │ 同名曲目，无法导入" │  │    (sourceScoreId = 原ID)  │      │
│         │                    │  │                            │      │
│         │                    │  │ 2. 联级复制所有分谱        │      │
│         │                    │  │    → TeamInstrumentScore   │      │
│         │                    │  │    → 复制 annotationsJson  │      │
│         │                    │  │    → 共用 pdfHash 和 PDF   │      │
│         └────────────────────┘  └────────────────────────────┘      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 在 TeamScore 详情页添加/复制分谱

**与个人库一致：可以直接创建新分谱、复制已有分谱到其他乐器、或从个人库导入分谱**

```
┌─────────────────────────────────────────────────────────────────────┐
│  在 TeamScore 详情页管理分谱（与个人库一致）                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  场景: Team 中已有 "Canon - Pachelbel"                               │
│                                                                      │
│                    ┌─────────────────────┐                          │
│                    │ TeamScore 详情页     │                          │
│                    │ "Canon - Pachelbel" │                          │
│                    │                     │                          │
│                    │ 现有分谱:            │                          │
│                    │ • Violin    [复制][删除] │                      │
│                    │ • Cello     [复制][删除] │                      │
│                    │                     │                          │
│                    │ [+ 添加分谱] ◄──────│──── 点击                  │
│                    └─────────┬───────────┘                          │
│                              │                                       │
│  功能 1: 直接添加新分谱       │                                       │
│  ┌──────────────────────────┴─────────────────────────────────────┐ │
│  │ • 选择乐器类型                                                  │ │
│  │ • 导入新 PDF 文件                                               │ │
│  │ • 创建 TeamInstrumentScore                                     │ │
│  │ • PDF 上传到服务器（与个人库同步逻辑一致）                        │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  功能 2: 复制分谱到其他乐器                                          │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ • 点击某个分谱的 [复制] 按钮                                    │ │
│  │ • 选择目标乐器类型                                              │ │
│  │ • 复制 PDF 引用（pdfHash）和 annotations                        │ │
│  │ • 创建新的 TeamInstrumentScore                                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  功能 3: 从个人库导入分谱                                            │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ • 点击添加分谱时选择 "从 Library 导入"                          │ │
│  │ • 显示个人库 Score 列表供用户选择                               │ │
│  │ • 选择 Score 后显示该 Score 的所有乐器分谱                       │ │
│  │ • 用户选择需要导入的乐器（排除 Team 中已有的乐器）               │ │
│  │ • 复制 PDF 引用（pdfHash）和 annotations                        │ │
│  │ • 创建 TeamInstrumentScore                                      │ │
│  │ • 注意：只导入分谱，不修改 TeamScore 的 title/composer           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  功能 4: 删除分谱                                                    │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ • 至少保留一个分谱（最后一个不可删除）                           │ │
│  │ • 标记 deletedAt 进行软删除                                     │ │
│  │ • 同步到服务器                                                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3.1 从个人库导入分谱到 TeamScore 的详细流程

```
┌─────────────────────────────────────────────────────────────────────┐
│  从个人库导入分谱到已有 TeamScore                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  步骤 1: 选择源 Score                                                │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ • 显示个人库所有 Score 列表                                     │ │
│  │ • 用户可搜索/筛选                                               │ │
│  │ • 选择一个 Score 作为分谱来源                                   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  步骤 2: 选择要导入的乐器分谱                                        │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 显示源 Score 的所有 InstrumentScore:                            │ │
│  │                                                                 │ │
│  │ ☐ Violin    (√ 可选)                                           │ │
│  │ ☐ Piano     (√ 可选)                                           │ │
│  │ ◌ Cello     (× 已存在，灰色禁用)                                │ │
│  │ ☐ Flute     (√ 可选)                                           │ │
│  │                                                                 │ │
│  │ [取消]  [导入选中的分谱]                                        │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  步骤 3: 执行导入                                                    │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ FOR EACH 选中的 InstrumentScore:                                │ │
│  │   • 创建 TeamInstrumentScore                                    │ │
│  │   • 复制 pdfHash (共用 PDF 文件)                                │ │
│  │   • 复制 annotationsJson                                        │ │
│  │   • 设置 sourceInstrumentScoreId = 原分谱 serverId              │ │
│  │   • pdfSyncStatus = 'synced' (因为个人库 PDF 已存在)            │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 从 Library 导入 Setlist 的流程

**重要：不支持导入重复的 Setlist！联级导入所有相关 Score**

```
┌─────────────────────────────────────────────────────────────────────┐
│  从 Library 导入 Setlist 到 Team                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  步骤 1: 检查 Setlist 本身                                           │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Team 中是否已有同名 Setlist？                                   │ │
│  │ ├── YES → ❌ 拒绝导入，提示 "曲单已存在于团队中"               │ │
│  │ └── NO  → ✅ 继续                                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  步骤 2: 联级处理 Setlist 中的每个 Score                             │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ FOR EACH Score in Setlist:                                      │ │
│  │                                                                 │ │
│  │   ┌─────────────────────────────────────────────────────────┐  │ │
│  │   │ Team 中是否有同名 (title + composer) 的 TeamScore？     │  │ │
│  │   └────────────────────────┬────────────────────────────────┘  │ │
│  │                    ┌───────┴───────┐                           │ │
│  │                   YES              NO                           │ │
│  │                    │               │                            │ │
│  │                    ▼               ▼                            │ │
│  │           ┌─────────────┐  ┌─────────────────────────────┐     │ │
│  │           │ ✅ 复用已有  │  │ ✅ 联级复制 Score 到 Team   │     │ │
│  │           │ 的 TeamScore │  │ → 创建 TeamScore            │     │ │
│  │           │             │  │ → 联级复制所有分谱           │     │ │
│  │           │ 不添加新分谱 │  │ → 联级复制 annotations      │     │ │
│  │           │ (与导入Score │  │ → 共用 PDF                  │     │ │
│  │           │  规则一致)   │  └─────────────────────────────┘     │ │
│  │           └─────────────┘                                      │ │
│  │                                                                 │ │
│  │   记录: scoreMapping[原ScoreId] = TeamScoreId                   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  步骤 3: 创建 TeamSetlist                                            │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 创建 TeamSetlist                                                │ │
│  │ ├── sourceSetlistId = 原 Setlist.serverId                      │ │
│  │ └── 其他元数据复制                                              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  步骤 4: 创建 TeamSetlistScore 关联                                  │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ FOR EACH 原 SetlistScore:                                       │ │
│  │   创建 TeamSetlistScore                                         │ │
│  │   ├── teamSetlistId = 新创建的 TeamSetlist.id                   │ │
│  │   ├── teamScoreId = scoreMapping[原ScoreId]                     │ │
│  │   └── orderIndex = 原顺序                                       │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 直接创建的唯一性检查

```
┌─────────────────────────────────────────────────────────────────────┐
│  在 Team 中直接创建 Score                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│                    ┌─────────────────────┐                          │
│                    │ 用户点击 Add 按钮    │                          │
│                    │ → 选择 "直接创建"   │                          │
│                    │ → 导入 PDF          │                          │
│                    │ → 输入 title/composer│                         │
│                    └─────────┬───────────┘                          │
│                              │                                       │
│                              ▼                                       │
│            ┌─────────────────────────────────┐                      │
│            │ 检查: Team 中是否有同名 Score？  │                      │
│            └────────────────┬────────────────┘                      │
│                     ┌───────┴───────┐                               │
│                    YES              NO                               │
│                     │               │                                │
│                     ▼               ▼                                │
│          ┌──────────────────┐ ┌──────────────────┐                  │
│          │ 提示: "团队中已有 │ │ 检查分谱唯一性    │                  │
│          │ 同名曲目"        │ │ (instrumentType)  │                  │
│          │                  │ └─────────┬────────┘                  │
│          │ 选项:            │           │                            │
│          │ • 添加分谱到已有  │    ┌──────┴──────┐                     │
│          │ • 取消创建       │   YES            NO                    │
│          └──────────────────┘    │              │                    │
│                                  ▼              ▼                    │
│                        ┌─────────────┐  ┌─────────────┐             │
│                        │ 分谱已存在   │  │ 创建成功    │             │
│                        │ 提示并终止   │  │             │             │
│                        └─────────────┘  └─────────────┘             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.6 导入规则总结

| 场景 | 处理方式 |
|------|---------|
| **从 Add 按钮导入 Score** | |
| → Team 中无同名 | ✅ 导入，联级创建 TeamScore + 所有 TeamInstrumentScore + annotations |
| → Team 中有同名 | ❌ 拒绝，提示去 TeamScore 详情页添加分谱 |
| **从 Add 按钮导入 Setlist** | |
| → Team 中无同名 Setlist | ✅ 导入，联级处理所有 Score（已有的复用，没有的创建）|
| → Team 中有同名 Setlist | ❌ 拒绝导入 |
| **在 TeamScore 详情页添加分谱** | |
| → 从 Library 同名曲目导入 | ✅ 只能添加 Team 中不存在的分谱类型 |
| → 直接创建新分谱 | ✅ 只要分谱类型不重复 |
| **直接创建 Score** | |
| → Team 中无同名 | ✅ 创建成功 |
| → Team 中有同名 | 提示选择：添加分谱到已有 / 取消 |
| **PDF 处理** | 与本地 Library 共用，基于 pdfHash |

---

## 4. 同步流程

### 4.1 同步状态机

```
                         ┌─────────────────────────────┐
                         │                             │
                         ▼                             │
    ┌───────┐   数据变更(5s防抖)   ┌─────────┐  success │
    │ idle  │ ──────────────────► │ syncing │ ─────────┘
    └───────┘                     └─────────┘
        ▲                              │
        │ network restored             │ error / 412 conflict
        │                              ▼
    ┌────────┐                    ┌─────────┐
    │ paused │ ◄── no network ─── │  error  │
    └────────┘                    └─────────┘
        │                              │
        │                              │ retry(30s)
        └──────────────────────────────┘
```

### 4.2 完整同步周期

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Team 同步周期                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  FOR EACH Team (用户加入的团队):                                     │
│                                                                      │
│  ╔════════════════════════════════════════════════════════════════╗ │
│  ║  阶段 1: PUSH 本地变更                                          ║ │
│  ╠════════════════════════════════════════════════════════════════╣ │
│  ║                                                                 ║ │
│  ║  1. 收集待同步数据:                                              ║ │
│  ║     WHERE teamId = ? AND syncStatus = 'pending'                ║ │
│  ║     ├── TeamScores                                             ║ │
│  ║     ├── TeamInstrumentScores (含 annotationsJson)              ║ │
│  ║     ├── TeamSetlists                                           ║ │
│  ║     └── TeamSetlistScores                                      ║ │
│  ║                                                                 ║ │
│  ║  2. 发送请求: POST /team/{teamId}/push                         ║ │
│  ║     请求体包含 clientTeamLibraryVersion 和各实体数组            ║ │
│  ║                                                                 ║ │
│  ║  3. 处理响应:                                                   ║ │
│  ║     ├── 200 OK → 更新 syncStatus = 'synced'                    ║ │
│  ║     └── 412 Conflict → 跳到阶段 2                              ║ │
│  ╚════════════════════════════════════════════════════════════════╝ │
│                                │                                     │
│                                ▼                                     │
│  ╔════════════════════════════════════════════════════════════════╗ │
│  ║  阶段 2: PULL 远程变更                                          ║ │
│  ╠════════════════════════════════════════════════════════════════╣ │
│  ║                                                                 ║ │
│  ║  1. 请求增量数据:                                               ║ │
│  ║     GET /team/{teamId}/pull?since={teamLibraryVersion}         ║ │
│  ║                                                                 ║ │
│  ║  2. 响应包含:                                                   ║ │
│  ║     ├── teamLibraryVersion (最新版本号)                        ║ │
│  ║     ├── teamScores, teamInstrumentScores (含 pdfHash)          ║ │
│  ║     ├── teamSetlists, teamSetlistScores                        ║ │
│  ║     └── deleted 数组                                           ║ │
│  ║                                                                 ║ │
│  ║  3. 合并策略:                                                   ║ │
│  ║     ├── 本地 pending → 保留本地                                 ║ │
│  ║     ├── 本地 synced  → 使用服务器数据                           ║ │
│  ║     └── 本地不存在   → 创建新记录 (pdfSyncStatus=needsDownload) ║ │
│  ║                                                                 ║ │
│  ║  4. 更新本地 teamLibraryVersion                                ║ │
│  ╚════════════════════════════════════════════════════════════════╝ │
│                                │                                     │
│                                ▼                                     │
│  ╔════════════════════════════════════════════════════════════════╗ │
│  ║  阶段 3: PDF 文件同步 (后台自动同步)                              ║ │
│  ╠════════════════════════════════════════════════════════════════╣ │
│  ║                                                                 ║ │
│  ║  与个人库一致：后台自动下载 + 优先级队列                         ║ │
│  ║                                                                 ║ │
│  ║  上传队列 (本地创建的 PDF):                                      ║ │
│  ║  ├── pdfSyncStatus = 'pending' AND pdfHash IS NOT NULL         ║ │
│  ║  └── 使用全局 pdfHash 秒传机制                                  ║ │
│  ║                                                                 ║ │
│  ║  下载队列 (后台自动下载):                                        ║ │
│  ║  ├── pdfSyncStatus = 'needs_download' AND pdfHash IS NOT NULL  ║ │
│  ║  ├── 优先级 1: 用户当前打开的 PDF (立即下载)                    ║ │
│  ║  ├── 优先级 2: Setlist 相邻的 Score (预加载)                    ║ │
│  ║  └── 优先级 3: 后台空闲时自动下载                               ║ │
│  ║                                                                 ║ │
│  ╚════════════════════════════════════════════════════════════════╝ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 多 Team 同步策略

```
┌─────────────────────────────────────────────────────────────────────┐
│  多 Team 同步                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  用户可能加入多个 Team，每个 Team 独立同步:                           │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ User                                                         │    │
│  │ ├── Team A (teamLibraryVersion = 105)                       │    │
│  │ │   ├── TeamScore A1                                        │    │
│  │ │   └── TeamSetlist A1                                      │    │
│  │ │                                                            │    │
│  │ ├── Team B (teamLibraryVersion = 42)                        │    │
│  │ │   ├── TeamScore B1, B2                                    │    │
│  │ │   └── TeamSetlist B1                                      │    │
│  │ │                                                            │    │
│  │ └── Team C (teamLibraryVersion = 7)                         │    │
│  │     └── TeamScore C1                                        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  同步顺序: 并行或串行都可以，每个 Team 独立版本号                     │
│  触发时机: 任一 Team 数据变更都会触发该 Team 的同步                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.4 Push 请求格式

**请求端点：** `POST /team/{teamId}/push`

**请求体：**

```dart
TeamSyncPushRequest {
  clientTeamLibraryVersion: int,       // 客户端当前版本号
  teamScores: List<TeamScoreData>,     // TeamScore 实体
  teamInstrumentScores: List<TeamInstrumentScoreData>,  // 含 pdfHash + annotationsJson
  teamSetlists: List<TeamSetlistData>,
  teamSetlistScores: List<TeamSetlistScoreData>,
  deletes: List<String>,               // ["teamScore:123", "teamInstrumentScore:456", ...]
}
```

### 4.5 Pull 响应格式

**请求端点：** `GET /team/{teamId}/pull?since={version}`

**响应体：**

```dart
TeamSyncPullResponse {
  teamLibraryVersion: int,              // 最新版本号
  isFullSync: bool,                     // 是否全量同步

  teamScores: List<TeamScoreData>?,
  teamInstrumentScores: List<TeamInstrumentScoreData>?,  // 含 pdfHash + annotationsJson
  teamSetlists: List<TeamSetlistData>?,
  teamSetlistScores: List<TeamSetlistScoreData>?,

  deleted: List<String>?,               // 已删除实体
}

TeamInstrumentScoreData {
  id: int,
  teamScoreId: int,
  instrumentType: String,
  customInstrument: String?,
  pdfHash: String?,                     // PDF 标识，用于下载
  annotationsJson: String?,             // 标注数据
  version: int,
  isDeleted: bool,
}
```

---

## 5. PDF 文件处理

### 5.1 PDF 存储架构（复用个人库）

```
┌─────────────────────────────────────────────────────────────────────┐
│  PDF 存储架构 (Team 与个人库共享)                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  客户端本地存储:                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  /documents/pdfs/                    ← 统一目录              │    │
│  │  ├── abc123def456.pdf                                        │    │
│  │  ├── 789xyz000111.pdf                                        │    │
│  │  └── ...                                                     │    │
│  │                                                              │    │
│  │  个人库 InstrumentScore:                                     │    │
│  │  │ id=1 │ pdfHash=abc123 │ pdfPath=/pdfs/abc123.pdf │       │    │
│  │                                                              │    │
│  │  Team InstrumentScore:                                       │    │
│  │  │ id=1 │ pdfHash=abc123 │ pdfPath=/pdfs/abc123.pdf │ ← 共享 │    │
│  │                                                              │    │
│  │  引用计数 = 个人库引用 + Team 引用                            │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  服务器全局存储:                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  /uploads/global/pdfs/              ← 全局目录，跨用户去重    │    │
│  │  ├── abc123def456.pdf                                        │    │
│  │  └── ...                                                     │    │
│  │                                                              │    │
│  │  全局引用计数 = 所有个人库 + 所有 Team 的引用                 │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 PDF 下载策略（与个人库完全一致）

**策略：后台自动下载 + 优先级队列**

Team 和个人库共用同一个 PDF 同步服务 `PdfSyncService`，确保：
1. 代码复用，逻辑一致
2. 基于 pdfHash 的全局去重（Team 和个人库共享 PDF 文件）
3. 统一的优先级队列管理

```
┌─────────────────────────────────────────────────────────────────────┐
│  统一 PDF 下载策略 (Library + Team 共用)                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  优先级队列 (Priority Queue):                                        │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Priority 1 (最高): 用户当前正在打开的 PDF                      │ │
│  │  ├── 立即下载，显示进度条                                       │ │
│  │  └── 阻塞操作，用户必须等待下载完成                             │ │
│  │                                                                 │ │
│  │  Priority 2: 用户即将查看的 PDF                                 │ │
│  │  ├── 预加载 Setlist 中相邻的 Score                              │ │
│  │  └── 后台静默下载，不阻塞用户操作                               │ │
│  │                                                                 │ │
│  │  Priority 3 (最低): 后台自动下载队列                            │ │
│  │  ├── WiFi 环境下自动下载所有未缓存的 PDF                        │ │
│  │  ├── 包括个人库 + 所有 Team 的 PDF                              │ │
│  │  └── 可被高优先级任务打断                                       │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  下载触发时机:                                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  1. 用户打开 Score 详情页 (Library 或 Team)                     │ │
│  │     → 预加载该 Score 所有 instrument 的 PDF                     │ │
│  │                                                                 │ │
│  │  2. 用户打开 Setlist 详情页 (Library 或 Team)                   │ │
│  │     → 预加载 Setlist 中前 N 个 Score 的 PDF                     │ │
│  │                                                                 │ │
│  │  3. 用户点击查看某个 InstrumentScore                            │ │
│  │     → 立即加载（最高优先级）                                    │ │
│  │                                                                 │ │
│  │  4. Sync 完成后 (Pull 阶段结束)                                 │ │
│  │     → 触发后台下载队列检查                                      │ │
│  │     → 遍历所有 pdfSyncStatus='needs_download' 的记录            │ │
│  │     → 按 createdAt 倒序下载（新的优先）                         │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  去重机制:                                                           │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  下载前检查 /pdfs/{hash}.pdf 是否已存在:                        │ │
│  │  ├── 已存在 → 直接更新 pdfPath, pdfSyncStatus='synced'         │ │
│  │  └── 不存在 → 下载并保存到 /pdfs/{hash}.pdf                    │ │
│  │                                                                 │ │
│  │  这确保相同 PDF 在个人库和多个 Team 之间只下载一次               │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.3 PDF 按需下载流程（优先级 1）

```
┌─────────────────────────────────────────────────────────────────────┐
│  PDF 按需下载 (用户打开 Score 时)                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 用户打开某个 Score (Library 或 Team)                            │ │
│  └───────────────────────────┬────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 获取该 Score 下用户选择的 InstrumentScore                       │ │
│  └───────────────────────────┬────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ PdfSyncService.downloadWithPriority(pdfHash, Priority.HIGH)    │ │
│  └───────────────────────────┬────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 检查本地 /pdfs/{pdfHash}.pdf 是否存在                           │ │
│  │ (全局去重：可能来自个人库或其他 Team)                            │ │
│  └───────────────────────────┬────────────────────────────────────┘ │
│                      ┌───────┴───────┐                              │
│                   已存在            不存在                           │
│                      │               │                               │
│                      ▼               ▼                               │
│          ┌─────────────────┐  ┌─────────────────────────────────┐   │
│          │ 复用已有文件     │  │ 显示下载进度                     │   │
│          │ 更新 pdfPath    │  │ GET /file/download/{pdfHash}    │   │
│          │ pdfSyncStatus   │  │                                  │   │
│          │  = 'synced'     │  │ 下载完成:                        │   │
│          └─────────────────┘  │ • 保存到 /pdfs/{hash}.pdf        │   │
│                               │ • 验证 Hash                      │   │
│                               │ • 更新 pdfPath, pdfSyncStatus    │   │
│                               └─────────────────────────────────┘   │
│                                       │                              │
│                                       ▼                              │
│                         ┌─────────────────────────┐                 │
│                         │ 打开 PDF 阅读器显示内容  │                 │
│                         └─────────────────────────┘                 │
│                                                                      │
│  同时触发后台预加载:                                                 │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ • 预加载该 Score 其他 instrument 的 PDF (Priority 2)            │ │
│  │ • 如果从 Setlist 进入，预加载相邻 Score 的 PDF (Priority 2)     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.4 PDF 后台自动下载配置

```
┌─────────────────────────────────────────────────────────────────────┐
│  后台自动下载配置 (Library + Team 统一配置)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  配置项 (Settings):                                                  │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  pdfAutoDownload: bool = true                                   │ │
│  │  ├── true:  WiFi 下自动后台下载所有 PDF (Library + Team)        │ │
│  │  └── false: 仅按需下载，不自动预加载                            │ │
│  │                                                                 │ │
│  │  pdfPreloadCount: int = 3                                       │ │
│  │  ├── 进入 Setlist 时预加载前 N 个 Score 的 PDF                  │ │
│  │  └── 0 表示不预加载                                             │ │
│  │                                                                 │ │
│  │  pdfDownloadOnCellular: bool = false                            │ │
│  │  ├── true:  允许在移动网络下后台下载                            │ │
│  │  └── false: 仅 WiFi 下自动下载（手动触发除外）                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  pdfSyncStatus 状态机:                                               │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  pending ───────(上传中)──────► uploading ────(完成)───► synced │ │
│  │     │                                                           │ │
│  │     └─────────(本地无 PDF)─────► needs_download                 │ │
│  │                                        │                        │ │
│  │                                        ▼                        │ │
│  │                                   downloading                   │ │
│  │                                        │                        │ │
│  │                            ┌──────────┴──────────┐              │ │
│  │                         (完成)                (本地已有)         │ │
│  │                            │                     │              │ │
│  │                            ▼                     ▼              │ │
│  │                         synced ◄────────────────┘              │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  状态说明:                                                           │
│  ├── pending:         本地新建，PDF 待上传                          │
│  ├── uploading:       PDF 正在上传                                  │
│  ├── needs_download:  从服务器 Pull 回来，PDF 需要下载               │
│  ├── downloading:     PDF 正在下载                                  │
│  └── synced:          PDF 已同步完成                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.5 PDF 上传流程（秒传机制）

```
┌─────────────────────────────────────────────────────────────────────┐
│  Team PDF 上传                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  场景 1: 直接在 Team 创建 Score (导入新 PDF)                         │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. 计算 PDF 的 MD5 Hash                                        │ │
│  │ 2. 调用 GET /file/checkHash?hash={hash}                        │ │
│  │    ├── 已存在 → 秒传成功，无需上传                              │ │
│  │    └── 不存在 → POST /file/upload 上传文件                     │ │
│  │ 3. 更新 pdfSyncStatus = 'synced'                               │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  场景 2: 从个人库复制 Score 到 Team                                  │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. 复制 pdfHash 值                                             │ │
│  │ 2. 如果个人库的 PDF 已同步 (pdfSyncStatus='synced')             │ │
│  │    → Team 的 pdfSyncStatus = 'synced' (服务器已有)              │ │
│  │ 3. 如果个人库的 PDF 未同步 (pdfSyncStatus='pending')            │ │
│  │    → Team 的 pdfSyncStatus = 'pending' (等待上传)               │ │
│  │ 4. 本地文件复用，无需复制文件                                   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.4 引用计数管理

```
┌─────────────────────────────────────────────────────────────────────┐
│  本地 PDF 引用计数                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  计算公式:                                                           │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ localRefCount =                                                 │ │
│  │   COUNT(InstrumentScore WHERE pdfHash = ? AND deletedAt IS NULL)│ │
│  │ + COUNT(TeamInstrumentScore WHERE pdfHash = ? AND deletedAt IS NULL) │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  删除 TeamInstrumentScore 时:                                        │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. 获取 pdfHash                                                 │ │
│  │ 2. 计算删除后的 localRefCount                                   │ │
│  │ 3. if localRefCount == 0 → 删除本地 PDF 文件                    │ │
│  │ 4. 服务器端单独处理全局引用计数                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 冲突解决

### 6.1 版本冲突 (412 Conflict)

```
┌─────────────────────────────────────────────────────────────────────┐
│  版本冲突场景                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  T1: 服务器 teamLibraryVersion = 10                                 │
│      ├── 成员 A 设备 = 10                                           │
│      └── 成员 B 设备 = 10                                           │
│                                                                      │
│  T2: 成员 A Push "新曲目" 成功                                       │
│      服务器 teamLibraryVersion = 11                                 │
│      成员 A 设备 = 11                                                │
│                                                                      │
│  T3: 成员 B 修改曲目（本地版本仍 = 10）                               │
│                                                                      │
│  T4: 成员 B Push，带着 clientTeamLibraryVersion = 10                │
│      服务器: 10 < 11 → 返回 412                                     │
│                                                                      │
│  T5: 成员 B Pull，获取版本 11 的数据                                 │
│      成员 B 本地版本 = 11                                            │
│      pending 数据被保留（本地胜出）                                  │
│                                                                      │
│  T6: 成员 B 再次 Push，成功                                          │
│      服务器版本 = 12                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 数据冲突 Merge 逻辑

```
┌─────────────────────────────────────────────────────────────────────┐
│  Merge 决策树                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  对于每个服务器返回的实体:                                           │
│                                                                      │
│                    ┌─────────────────┐                              │
│                    │ 服务器实体到达   │                              │
│                    └────────┬────────┘                              │
│                             │                                        │
│                             ▼                                        │
│                    ┌─────────────────┐                              │
│                    │ 本地存在记录？   │                              │
│                    └────────┬────────┘                              │
│                     │              │                                 │
│                    YES             NO                                │
│                     │              │                                 │
│                     ▼              ▼                                 │
│            ┌──────────────┐  ┌──────────────────┐                   │
│            │ 检查 syncStatus │  │ 创建新记录        │                   │
│            └───────┬──────┘  │ syncStatus=synced│                   │
│                    │         │ pdfSyncStatus=   │                   │
│         ┌──────────┴─────────┐  needsDownload   │                   │
│         │                    │  └──────────────────┘                   │
│      pending              synced                                     │
│         │                    │                                       │
│         ▼                    ▼                                       │
│  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ 本地优先         │  │ 服务器优先       │                           │
│  │ 跳过，不覆盖     │  │ 用服务器数据更新  │                           │
│  │ hadConflict=true│  │ syncStatus=synced│                           │
│  └─────────────────┘  └─────────────────┘                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.3 删除冲突处理

| 场景 | 条件 | 处理方式 |
|------|------|---------|
| 服务器删除 + 本地已同步 | 本地 syncStatus='synced' | 物理删除本地记录 |
| 服务器删除 + 本地有修改 | 本地 syncStatus='pending' | 保留本地，下次 Push 时恢复 |
| 本地删除 + 服务器有更新 | 本地 deletedAt 不为空且 pending | 删除优先，Push 删除请求 |

---

## 7. 特殊场景

### 7.1 加入新 Team（全量同步）

```
┌─────────────────────────────────────────────────────────────────────┐
│  加入新 Team 流程                                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. 用户通过邀请码加入 Team                                          │
│     │                                                                │
│     ▼                                                                │
│  2. 初始化该 Team 的本地状态                                         │
│     teamLibraryVersion = 0                                          │
│     │                                                                │
│     ▼                                                                │
│  3. Pull 全量元数据 (since = 0)                                      │
│     ┌─────────────────────────────────────────────────┐             │
│     │ 服务器返回所有: TeamScores, TeamInstrumentScores,│             │
│     │ TeamSetlists, TeamSetlistScores                 │             │
│     │ TeamInstrumentScore 包含 pdfHash (用于后续下载) │             │
│     └─────────────────────────────────────────────────┘             │
│     │                                                                │
│     ▼                                                                │
│  4. 保存到本地数据库                                                 │
│     所有 TeamInstrumentScore 的 pdfSyncStatus = 'needsDownload'     │
│     │                                                                │
│     ▼                                                                │
│  5. UI 立即可用                                                      │
│     用户可以看到 Team 的曲库列表、曲单列表                            │
│     │                                                                │
│     ▼                                                                │
│  6. PDF 按需下载                                                     │
│     用户打开某个分谱时才下载对应 PDF                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 退出 Team

```
┌─────────────────────────────────────────────────────────────────────┐
│  退出 Team 流程                                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. 用户点击 "退出团队"                                              │
│     │                                                                │
│     ▼                                                                │
│  2. 检查是否有未同步数据                                             │
│     ├─ 有 → 提示 "有未同步的数据，确定退出？"                        │
│     └─ 无 → 继续                                                     │
│     │                                                                │
│     ▼                                                                │
│  3. 调用 API 退出 Team                                               │
│     │                                                                │
│     ▼                                                                │
│  4. 清空该 Team 的本地数据                                           │
│     ├─ 删除该 Team 的所有 TeamScore, TeamInstrumentScore 等         │
│     ├─ 检查 PDF 引用计数，删除不再需要的 PDF                         │
│     └─ 删除该 Team 的 TeamSyncState                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.3 离线使用

```
┌─────────────────────────────────────────────────────────────────────┐
│  离线场景                                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  离线操作:                                                           │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ • 所有操作正常写入本地数据库                                  │    │
│  │ • syncStatus = 'pending'                                    │    │
│  │ • UI 正常响应                                                │    │
│  │ • 网络恢复后自动同步                                         │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  离线时尝试打开未下载的 PDF:                                         │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ • 显示 "PDF 尚未下载，请连接网络后再试"                       │    │
│  │ • 或显示占位图                                               │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.4 成员编辑同一数据

```
┌─────────────────────────────────────────────────────────────────────┐
│  多成员编辑冲突                                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  场景: 成员 A 和 B 同时编辑同一个 TeamScore                          │
│                                                                      │
│  T1: 成员 A 和 B 都看到 BPM = 120                                    │
│                                                                      │
│  T2: 成员 A 改为 BPM = 130，本地 pending                             │
│      成员 B 改为 BPM = 140，本地 pending                             │
│                                                                      │
│  T3: 成员 A 先 Push 成功，服务器 BPM = 130                           │
│                                                                      │
│  T4: 成员 B Push 失败 (412)                                          │
│      成员 B Pull，发现服务器 BPM = 130                               │
│      但成员 B 本地是 pending，所以保留 BPM = 140                     │
│                                                                      │
│  T5: 成员 B 再次 Push，成功，服务器 BPM = 140                        │
│                                                                      │
│  结果: Last-Write-Wins，成员 B 的修改最终生效                        │
│  注意: 这是预期行为，所有成员都有编辑权限                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 附录

### A. API 端点汇总

| 端点 | 方法 | 说明 |
|------|------|------|
| `/team/{teamId}/push` | POST | 推送本地变更 |
| `/team/{teamId}/pull?since={version}` | GET | 拉取远程变更 |
| `/team/{teamId}/scores` | GET | 获取 Team 所有 Score |
| `/team/{teamId}/setlists` | GET | 获取 Team 所有 Setlist |
| `/file/checkHash?hash={hash}` | GET | 检查 PDF 是否已存在（秒传） |
| `/file/upload` | POST | 上传 PDF |
| `/file/download/{hash}` | GET | 下载 PDF |

### B. 本地数据库表结构

```sql
-- Team 同步状态
CREATE TABLE team_sync_state (
  team_id INTEGER PRIMARY KEY,
  team_library_version INTEGER NOT NULL DEFAULT 0,
  last_sync_at TEXT
);

-- TeamScore
CREATE TABLE team_scores (
  id TEXT PRIMARY KEY,
  server_id INTEGER,
  team_id INTEGER NOT NULL,
  title TEXT NOT NULL,
  composer TEXT NOT NULL,
  bpm INTEGER DEFAULT 120,
  created_by_id INTEGER NOT NULL,
  source_score_id INTEGER,
  sync_status TEXT NOT NULL DEFAULT 'pending',
  version INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT,
  deleted_at TEXT,
  UNIQUE(team_id, title, composer)
);

-- TeamInstrumentScore
CREATE TABLE team_instrument_scores (
  id TEXT PRIMARY KEY,
  server_id INTEGER,
  team_score_id TEXT NOT NULL,
  instrument_type TEXT NOT NULL,
  custom_instrument TEXT,
  pdf_hash TEXT,
  pdf_path TEXT,
  pdf_sync_status TEXT NOT NULL DEFAULT 'pending',
  annotations_json TEXT,
  source_instrument_score_id INTEGER,
  sync_status TEXT NOT NULL DEFAULT 'pending',
  version INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT,
  deleted_at TEXT,
  FOREIGN KEY (team_score_id) REFERENCES team_scores(id),
  UNIQUE(team_score_id, instrument_type, custom_instrument)
);

-- TeamSetlist
CREATE TABLE team_setlists (
  id TEXT PRIMARY KEY,
  server_id INTEGER,
  team_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  created_by_id INTEGER NOT NULL,
  source_setlist_id INTEGER,
  sync_status TEXT NOT NULL DEFAULT 'pending',
  version INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT,
  deleted_at TEXT,
  UNIQUE(team_id, name)
);

-- TeamSetlistScore
CREATE TABLE team_setlist_scores (
  id TEXT PRIMARY KEY,
  server_id INTEGER,
  team_setlist_id TEXT NOT NULL,
  team_score_id TEXT NOT NULL,
  order_index INTEGER NOT NULL DEFAULT 0,
  sync_status TEXT NOT NULL DEFAULT 'pending',
  version INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT,
  deleted_at TEXT,
  FOREIGN KEY (team_setlist_id) REFERENCES team_setlists(id),
  FOREIGN KEY (team_score_id) REFERENCES team_scores(id),
  UNIQUE(team_setlist_id, team_score_id)
);
```

### C. 错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 网络超时 | 重试 3 次，指数退避 |
| 401 Unauthorized | 跳转登录页面 |
| 403 Not Team Member | 提示 "你不是该团队成员"，移除本地 Team 数据 |
| 412 Conflict | Pull → Merge → 重试 Push |
| 404 Team Not Found | 团队可能已解散，清理本地数据 |
| PDF 下载失败 | 保持 needsDownload 状态，用户再次打开时重试 |

### D. 日志记录

```
[TeamSyncService] === TEAM SYNC START (teamId=123) ===
[TeamSyncService] Push: teamScores=2, teamInstrumentScores=3, deletes=0
[TeamSyncService] Pull: pulled=5, conflicts=1
[TeamSyncService] PDF: pending uploads=1, needsDownload=3
[TeamSyncService] === TEAM SYNC COMPLETE (teamId=123): 1523ms ===
```
